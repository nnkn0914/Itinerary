<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Itinerary</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</title>

<style>
:root{
  --border:#ddd; --bg:#f6f6f6; --text:#111; --muted:#666; --black:#111;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text)}
.app{max-width:720px;margin:0 auto;padding:12px}

h2{margin:0;font-size:20px}
.sub{font-size:12px;color:var(--muted);margin-top:4px}
.hint{font-size:12px;color:var(--muted);margin-top:8px}

.day{border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px}
.day strong{font-size:14px}

.slot{margin-top:8px}
.slotHead{font-size:13px;font-weight:700;margin-bottom:4px}

.item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 8px;
  border-radius:10px;
  background:var(--bg);
  margin-top:4px;
  font-size:13px;
}
.item.empty{opacity:.5}

.time{font-weight:700;font-variant-numeric:tabular-nums}
.title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.tags{display:flex;gap:4px}
.tag{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--border)}
.tag.all{background:#111;color:#fff;border-color:#111}

.route{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  background:#111;
  color:#fff;
  text-decoration:none;
  white-space:nowrap;
}

/* bottom sheet */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25)}
.sheet{
  position:fixed;left:0;right:0;bottom:0;
  background:#fff;border-top:1px solid var(--border);
  border-radius:16px 16px 0 0;
  max-width:720px;margin:0 auto;
}
.sheetInner{padding:12px;max-height:60vh;overflow:auto}

.sheetHead{
  display:flex;align-items:center;justify-content:space-between
}
.sheetHead h4{margin:0;font-size:14px}

.addBtn{
  font-size:12px;
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:999px;
  background:#fff;
}

.input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin-top:8px;font-size:14px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}

.tagRow{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.tagBtn{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff;font-size:12px}
.tagBtn.active{background:#111;color:#fff;border-color:#111}

.actions{display:flex;gap:8px;padding:10px;border-top:1px solid #eee}
.actions button{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:700}
.actions .save{background:#111;color:#fff;border-color:#111}
</style>
</head>

<body>
<div class="app">
  <h2>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</h2>
  <div class="sub" id="range"></div>
  <div class="hint">ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†ï¼ˆåŒæ™‚ç·¨é›†ãƒ»è‡ªå‹•ä¿å­˜ï¼‰</div>
  <div id="root"></div>
</div>

<div class="backdrop" id="backdrop" style="display:none"></div>
<div class="sheet" id="sheet" style="display:none">
  <div class="sheetInner">
    <div class="sheetHead">
      <h4 id="sheetTitle"></h4>
      <button class="addBtn" id="addItemBtn" style="display:none">ï¼‹äºˆå®šã‚’è¿½åŠ </button>
    </div>

    <div id="itemsEditor"></div>
  </div>

  <div class="actions">
    <button id="closeBtn">é–‰ã˜ã‚‹</button>
    <button class="save" id="saveBtn">ä¿å­˜</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

/* ========= è¨­å®š ========= */
const SLOTS=[{key:"am",label:"AM"},{key:"pm",label:"PM"},{key:"dinner",label:"ãƒ‡ã‚£ãƒŠãƒ¼"}];
const TAGS=["All","ã‚ã‚“ã±","ã‚ã‚“ã¾","ã“ã†ã™ã‘","ãªãŠ"];
const START="2025-12-22";
const END="2026-01-09";

/* ğŸ”´ firebaseConfig ã‚’å·®ã—æ›¿ãˆ */
const firebaseConfig = {
  apiKey: "AIzaSyCzLFbx3hKRF5fzLb2qEoQb1RjuBKL9L64",
  authDomain: "itinerary-60bec.firebaseapp.com",
  projectId: "itinerary-60bec",
  storageBucket: "itinerary-60bec.firebasestorage.app",
  messagingSenderId: "174617579746",
  appId: "1:174617579746:web:fc1e6d74dd7c7b86a0cebb"
};

const $=id=>document.getElementById(id);

/* ========= util ========= */
const pad=n=>String(n).padStart(2,"0");
const toISO=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function dates(){
  const out=[];const d=new Date(START);
  while(true){out.push(toISO(d));if(toISO(d)>=END)break;d.setDate(d.getDate()+1)}
  return out;
}
function jp(iso){
  const d=new Date(iso);const w="æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[d.getDay()];
  return `${d.getMonth()+1}/${d.getDate()}(${w})`;
}
function mapHref(v){
  if(!v) return "";
  if(/^https?:\/\//.test(v)) return v;
  return "https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(v);
}

/* ========= data ========= */
const emptyItem=()=>({id:crypto.randomUUID(),time:"",title:"",map:"",tags:[]});
const emptyGrid=()=>Object.fromEntries(dates().map(d=>[d,Object.fromEntries(SLOTS.map(s=>[s.key,[]]))]));

/* ========= firebase ========= */
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

const trip=new URL(location.href).searchParams.get("trip")||"t"+Math.random().toString(36).slice(2);
const ref=doc(db,"trips",trip);

$("range").textContent=`${jp(START)}ã€œ${jp(END)}`;

let state={grid:emptyGrid()};
let editing=null;

function render(){
  const root=$("root");root.innerHTML="";
  dates().forEach(d=>{
    const day=document.createElement("div");
    day.className="day";
    day.innerHTML=`<strong>${jp(d)}</strong>`;
    SLOTS.forEach(s=>{
      const slot=document.createElement("div");
      slot.className="slot";
      slot.innerHTML=`<div class="slotHead">${s.label}</div>`;
      const items=state.grid[d][s.key];
      if(!items.length){
        slot.innerHTML+=`<div class="item empty">ï¼‹ è¿½åŠ </div>`;
      }else{
        items.forEach(it=>{
          const row=document.createElement("div");
          row.className="item";
          row.onclick=()=>openEditor(d,s.key);
          row.innerHTML=`
            <span class="time">${it.time||"--:--"}</span>
            <span class="title">${it.title||""}</span>
            ${it.map?`<a class="route" href="${mapHref(it.map)}" target="_blank" onclick="event.stopPropagation()">ğŸ“</a>`:""}
            <span class="tags">${it.tags.map(t=>`<span class="tag ${t==="All"?"all":""}">${t}</span>`).join("")}</span>
          `;
          slot.appendChild(row);
        });
      }
      slot.onclick=()=>openEditor(d,s.key);
      day.appendChild(slot);
    });
    root.appendChild(day);
  });
}

/* ========= editor ========= */
function openEditor(date,slot){
  editing={date,slot};
  const list=state.grid[date][slot];
  $("sheetTitle").textContent=`${jp(date)} / ${SLOTS.find(s=>s.key===slot).label}`;
  $("addItemBtn").style.display=list.length?"block":"none";
  const wrap=$("itemsEditor");wrap.innerHTML="";
  list.forEach(it=>wrap.appendChild(itemEditor(it)));
  if(!list.length) wrap.appendChild(itemEditor(emptyItem()));
  $("sheet").style.display="block";
  $("backdrop").style.display="block";
}

function itemEditor(it){
  const div=document.createElement("div");
  div.innerHTML=`
    <div class="row2">
      <input type="time" class="input" value="${it.time}">
      <input class="input" placeholder="äºˆå®šå" value="${it.title}">
    </div>
    <input class="input" placeholder="å ´æ‰€" value="${it.map}">
    <div class="tagRow"></div>
    <hr>
  `;
  const [time,title,map]=div.querySelectorAll("input");
  const tagRow=div.querySelector(".tagRow");

  TAGS.forEach(t=>{
    const b=document.createElement("button");
    b.className="tagBtn"+(it.tags.includes(t)?" active":"");
    b.textContent=t;
    b.onclick=()=>{
      if(t==="All") it.tags=["All"];
      else{
        it.tags=it.tags.filter(x=>x!=="All");
        it.tags.includes(t)?it.tags=it.tags.filter(x=>x!==t):it.tags.push(t);
      }
      render();
      openEditor(editing.date,editing.slot);
    };
    tagRow.appendChild(b);
  });

  time.oninput=e=>it.time=e.target.value;
  title.oninput=e=>it.title=e.target.value;
  map.oninput=e=>it.map=e.target.value;
  return div;
}

$("addItemBtn").onclick=()=>{
  state.grid[editing.date][editing.slot].push(emptyItem());
  openEditor(editing.date,editing.slot);
};

$("closeBtn").onclick=()=>{$("sheet").style.display="none";$("backdrop").style.display="none"};

$("saveBtn").onclick=async()=>{
  await updateDoc(ref,{grid:state.grid,updatedAt:serverTimestamp()});
  $("sheet").style.display="none";
  $("backdrop").style.display="none";
};

/* ========= boot ========= */
render();
signInAnonymously(auth);
onAuthStateChanged(auth,async u=>{
  if(!u)return;
  const snap=await getDoc(ref);
  if(!snap.exists()) await setDoc(ref,{grid:state.grid,createdAt:serverTimestamp()});
  onSnapshot(ref,s=>{
    state.grid=s.data().grid;
    render();
  });
});
</script>
</body>
</html>
    
  </body>
  
</html>
