<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Itinerary</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</title>
  <style>
    :root{
      --border:#ddd; --bg:#f6f6f6; --text:#111; --muted:#666; --black:#111;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:#fff;}
    .app{max-width:720px;margin:0 auto;padding:12px;}

    /* top */
    .topbar{
      position:sticky; top:0; z-index:50; background:#fff;
      padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    h2{margin:0;font-size:20px;line-height:1.2;}
    .sub{margin-top:4px;font-size:12px;color:var(--muted);}
    .tiny{margin-top:6px;font-size:11px;color:var(--muted);line-height:1.2;}
    .hint{margin:10px 0 0;font-size:12px;color:var(--muted);}

    /* day/cell */
    .day{border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px;}
    .day strong{font-size:14px;}

    .cell{
      position:relative;background:var(--bg);padding:10px;border-radius:12px;margin-top:8px;cursor:pointer;
      transition:opacity .15s ease, filter .15s ease;
    }
    .cell.empty{
      opacity:.55;
      padding:6px 10px;           /* ç©ºã¯ç¸¦å¹…ã‚’åŠåˆ†ãã‚‰ã„ */
      margin-top:6px;
      filter:saturate(.7);
    }
    .cellTitle{font-size:13px;line-height:1.35;padding-right:118px;}
    .rowline{margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .timePill{
      font-variant-numeric:tabular-nums;
      font-size:12px; font-weight:900;
      border:1px solid rgba(0,0,0,.12);
      padding:2px 8px; border-radius:999px; background:#fff;
      display:inline-flex; align-items:center; gap:6px;
      white-space:nowrap;
    }
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
    .chip{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;}
    .chip.active{background:var(--black);color:#fff;border-color:var(--black);}

    /* route badge */
    .routeBadge{
      position:absolute;top:8px;right:8px;font-size:12px;padding:7px 10px;border-radius:999px;
      background:var(--black);color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:6px;
      font-weight:900;border:1px solid var(--black);
    }
    .routeBadge:active{transform:translateY(1px);}

    /* sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:80;}
    .sheet{
      position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);
      z-index:90;max-width:720px;margin:0 auto;border-top-left-radius:16px;border-top-right-radius:16px;overflow:hidden;
    }
    .sheet-inner{padding:12px;max-height:62vh;overflow:auto;}
    .sheet-head{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .sheet-head h4{margin:0;font-size:14px;}

    .input{width:100%;padding:12px;margin-top:10px;border:1px solid var(--border);border-radius:12px;font-size:14px;}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
    .label{font-size:12px;color:var(--muted); margin-top:12px;}

    .tag-row{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
    .tag-btn{border:1px solid var(--border);background:#fff;padding:9px 12px;border-radius:999px;font-size:13px;cursor:pointer;white-space:nowrap;}
    .tag-btn.active{background:var(--black);color:#fff;border-color:var(--black);}

    .sheet-actions{
      display:flex;gap:8px;padding:10px 12px 12px;border-top:1px solid rgba(0,0,0,.06);background:#fff;
    }
    .btn{border:1px solid var(--border);background:#fff;border-radius:14px;cursor:pointer;}
    .btn.big{padding:14px 0;font-size:15px;font-weight:900;flex:1;min-width:0;}
    .btn.primary{background:var(--black);color:#fff;border-color:var(--black);flex:1.2;}
    .btn:active{transform:translateY(1px);}

    @media (max-width:520px){
      .app{padding:10px;}
      h2{font-size:18px;}
      .cellTitle{padding-right:102px;}
      .routeBadge{padding:7px 9px;font-size:12px;}
      .row2{grid-template-columns: 1fr; }
    }
    @media (max-width:380px){
      .sheet-actions{flex-wrap:wrap;}
      .btn.big{flex:1 1 calc(50% - 4px);}
      .btn.primary{flex:1 1 100%;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div>
        <h2>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</h2>
        <div class="sub" id="range"></div>
        <div class="tiny" id="tripInfo" style="display:none;"></div>
      </div>
      <!-- âœ… é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã¯å»ƒæ­¢ï¼ˆãƒœã‚¿ãƒ³ãªã—ï¼‰ -->
    </div>

    <p class="hint">ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†ï¼ˆåŒæ™‚ç·¨é›†ãƒ»è‡ªå‹•ä¿å­˜ï¼‰</p>
    <div id="root"></div>
  </div>

  <!-- Edit Sheet -->
  <div class="sheet-backdrop" id="backdrop" style="display:none;"></div>
  <div class="sheet" id="sheet" style="display:none;">
    <div class="sheet-inner">
      <div class="sheet-head">
        <h4 id="sheetTitle"></h4>
      </div>

      <div class="row2">
        <div>
          <div class="label">æ™‚é–“ï¼ˆã‚¿ãƒƒãƒ—ã§ãƒ›ã‚¤ãƒ¼ãƒ«ï¼‰</div>
          <input class="input" id="timeInput" type="time" />
        </div>
        <div>
          <div class="label">äºˆå®šå</div>
          <input class="input" id="titleInput" placeholder="ä¾‹ï¼šæœé£Ÿ / ãƒ›ãƒ†ãƒ«å‡ºç™º" />
        </div>
      </div>

      <div class="label">å ´æ‰€ï¼ˆGoogle Mapsãƒªãƒ³ã‚¯ or ä½æ‰€/åº—åï¼‰</div>
      <input class="input" id="mapInput" placeholder="ä¾‹ï¼šãƒ›ãƒ†ãƒ«å / æ¸‹è°·é§… / https://maps.app.goo.gl/..." />

      <div class="label">ã‚¿ã‚°ï¼ˆAllã¯ä»–ã¨åŒæ™‚é¸æŠä¸å¯ï¼‰</div>
      <div class="tag-row" id="tagRow"></div>
    </div>

    <div class="sheet-actions">
      <button class="btn big" id="closeBtn" type="button">é–‰ã˜ã‚‹</button>
      <button class="btn big" id="clearBtn" type="button">ã‚¯ãƒªã‚¢</button>
      <button class="btn big primary" id="saveBtn" type="button">ä¿å­˜</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // =====================
    // è¨­å®š
    // =====================
    const SLOTS = [
      { key: "am", label: "AM" },
      { key: "pm", label: "PM" },
      { key: "dinner", label: "ãƒ‡ã‚£ãƒŠãƒ¼" },
    ];

    // âœ… Allè¿½åŠ 
    const TAGS = ["All", "ã‚ã‚“ã±", "ã‚ã‚“ã¾", "ã“ã†ã™ã‘", "ãªãŠ"];

    // âœ… 12/21ã¯é™¤å¤–ï¼ˆ12/22ã€œ1/9ï¼‰
    const START = "2025-12-22";
    const END   = "2026-01-09";

    // âœ… ã‚ãªãŸã®firebaseConfigã«ç½®ãæ›ãˆ
const firebaseConfig = {
  apiKey: "AIzaSyCzLFbx3hKRF5fzLb2qEoQb1RjuBKL9L64",
  authDomain: "itinerary-60bec.firebaseapp.com",
  projectId: "itinerary-60bec",
  storageBucket: "itinerary-60bec.firebasestorage.app",
  messagingSenderId: "174617579746",
  appId: "1:174617579746:web:fc1e6d74dd7c7b86a0cebb"
};

    const $ = (id) => document.getElementById(id);

    // =====================
    // æ—¥ä»˜ï¼ˆJSTã‚ºãƒ¬é˜²æ­¢ï¼‰
    // =====================
    const pad = (n) => String(n).padStart(2, "0");
    const toLocalISO = (dt) => `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;

    function dateList(startIso, endIso){
      const out=[];
      const d = new Date(startIso + "T00:00:00");
      while(true){
        const iso = toLocalISO(d);
        out.push(iso);
        if(iso >= endIso) break;
        d.setDate(d.getDate()+1);
      }
      return out;
    }
    function formatJP(iso){
      const d = new Date(iso + "T00:00:00");
      const w = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()];
      return `${d.getMonth()+1}/${d.getDate()}(${w})`;
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function toMapHref(input){
      const s = String(input || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s;
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s)}`;
    }

    // =====================
    // 1æ =1ä»¶ å½¢å¼
    // cell: { time, title, map, tags[] }
    // =====================
    function emptyCell(){
      return { time: "", title: "", map: "", tags: [] };
    }
    function makeGrid(){
      const g = {};
      dateList(START, END).forEach(date => {
        g[date] = {};
        SLOTS.forEach(s => g[date][s.key] = emptyCell());
      });
      return g;
    }
    function cleanTags(tags){
      let t = Array.isArray(tags) ? tags.filter(x => TAGS.includes(x)) : [];
      return t.includes("All") ? ["All"] : t;
    }
    function normalizeGrid(raw){
      const g = makeGrid();
      if(!raw || typeof raw !== "object") return g;

      for(const date of Object.keys(g)){
        for(const s of SLOTS){
          const cell = raw?.[date]?.[s.key];
          if(!cell || typeof cell !== "object") continue;

          const time  = String(cell.time || "");
          const title = String(cell.title || "");
          const map   = String(cell.map || "");
          const tags  = cleanTags(cell.tags);

          g[date][s.key] = { time, title, map, tags };
        }
      }
      return g;
    }

    // =====================
    // tripIdï¼ˆURL paramï¼‰
    // =====================
    function randomTripId(){
      return "t" + Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,6);
    }
    function getOrCreateTripId(){
      const u = new URL(location.href);
      let trip = u.searchParams.get("trip");
      if(!trip){
        trip = randomTripId();
        u.searchParams.set("trip", trip);
        history.replaceState(null, "", u.toString());
      }
      return trip;
    }
    const tripId = getOrCreateTripId();

    $("range").textContent = `${formatJP(START)} ã€œ ${formatJP(END)}`;
    $("tripInfo").style.display = "block";
    $("tripInfo").textContent = `ã“ã®URLã‚’å…±æœ‰ã™ã‚‹ã¨åŒã˜äºˆå®šãŒè¦‹ãˆã¾ã™ï¼ˆID: ${tripId}ï¼‰`;

    // =====================
    // Firebase init
    // =====================
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const tripRef = doc(db, "trips", tripId);

    // =====================
    // state
    // =====================
    let state = { grid: makeGrid() };
    let editing = null; // {date, slotKey}
    let draft = emptyCell();
    let ready = false;
    let unsub = null;

    // =====================
    // UI
    // =====================
    function renderTagBtns(){
      const row = $("tagRow");
      row.innerHTML = "";
      TAGS.forEach(t => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "tag-btn" + (draft.tags.includes(t) ? " active" : "");
        b.textContent = t;

        b.onclick = () => {
          if(t === "All"){
            draft.tags = ["All"]; // Allæ’ä»–
          }else{
            draft.tags = draft.tags.filter(x => x !== "All");
            if(draft.tags.includes(t)) draft.tags = draft.tags.filter(x => x !== t);
            else draft.tags.push(t);
          }
          renderTagBtns();
        };
        row.appendChild(b);
      });
    }

    function openEdit(date, slotKey){
      editing = { date, slotKey };
      const slotLabel = SLOTS.find(x => x.key === slotKey)?.label || slotKey;
      $("sheetTitle").textContent = `${formatJP(date)} / ${slotLabel}`;

      const cell = state.grid?.[date]?.[slotKey] || emptyCell();
      draft = {
        time:  String(cell.time || ""),
        title: String(cell.title || ""),
        map:   String(cell.map || ""),
        tags:  cleanTags(cell.tags)
      };

      $("timeInput").value  = draft.time;
      $("titleInput").value = draft.title;
      $("mapInput").value   = draft.map;

      renderTagBtns();

      $("backdrop").style.display = "block";
      $("sheet").style.display = "block";
    }

    function closeSheet(){
      $("backdrop").style.display = "none";
      $("sheet").style.display = "none";
      editing = null;
    }

    function cellHasAny(cell){
      const t = String(cell?.title || "").trim();
      const m = String(cell?.map || "").trim();
      const ti = String(cell?.time || "").trim();
      const tags = Array.isArray(cell?.tags) ? cell.tags : [];
      return Boolean(t || m || ti || tags.length);
    }

    function render(){
      const root = $("root");
      root.innerHTML = "";

      dateList(START, END).forEach(date => {
        const day = document.createElement("div");
        day.className = "day";
        day.innerHTML = `<strong>${formatJP(date)}</strong>`;

        SLOTS.forEach(s => {
          const cellData = state.grid?.[date]?.[s.key] || emptyCell();
          const hasAny = cellHasAny(cellData);

          const cell = document.createElement("div");
          cell.className = "cell" + (hasAny ? "" : " empty");
          cell.addEventListener("click", () => openEdit(date, s.key));

          const mapHref = toMapHref(cellData.map);
          if(mapHref){
            const a = document.createElement("a");
            a.className = "routeBadge";
            a.href = mapHref;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "ğŸ“ãƒ«ãƒ¼ãƒˆæ¤œç´¢";
            a.addEventListener("click", (e) => e.stopPropagation());
            cell.appendChild(a);
          }

          const title = document.createElement("div");
          title.className = "cellTitle";
          title.innerHTML = `<strong>${s.label}</strong>ï¼š${hasAny ? "" : "ï¼‹ è¿½åŠ "}`;
          cell.appendChild(title);

          if(hasAny){
            const row = document.createElement("div");
            row.className = "rowline";
            if(cellData.time){
              const time = document.createElement("span");
              time.className = "timePill";
              time.textContent = `ğŸ•’ ${cellData.time}`;
              row.appendChild(time);
            }
            if(cellData.title){
              const t = document.createElement("span");
              t.style.fontSize = "13px";
              t.style.lineHeight = "1.35";
              t.innerHTML = escapeHtml(cellData.title);
              row.appendChild(t);
            }
            cell.appendChild(row);

            if((cellData.tags||[]).length){
              const chips = document.createElement("div");
              chips.className = "chips";
              cellData.tags.forEach(tg => {
                const sp = document.createElement("span");
                sp.className = "chip active";
                sp.textContent = tg;
                chips.appendChild(sp);
              });
              cell.appendChild(chips);
            }
          }

          day.appendChild(cell);
        });

        root.appendChild(day);
      });
    }

    // =====================
    // Firestore
    // =====================
    async function ensureTripDoc(){
      const snap = await getDoc(tripRef);
      if(!snap.exists()){
        await setDoc(tripRef, {
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          grid: makeGrid(),
        });
      }
    }

    async function saveCell(date, slotKey, cell){
      const payload = {
        time:  String(cell.time || "").trim(),
        title: String(cell.title || "").trim(),
        map:   String(cell.map || "").trim(),
        tags:  cleanTags(cell.tags)
      };

      const update = {};
      update[`grid.${date}.${slotKey}`] = payload;
      update["updatedAt"] = serverTimestamp();
      await updateDoc(tripRef, update);
    }

    // =====================
    // Events
    // =====================
    $("backdrop").addEventListener("click", closeSheet);
    $("closeBtn").addEventListener("click", closeSheet);

    $("timeInput").addEventListener("input", (e) => (draft.time = e.target.value));
    $("titleInput").addEventListener("input", (e) => (draft.title = e.target.value));
    $("mapInput").addEventListener("input", (e) => (draft.map = e.target.value));

    $("clearBtn").addEventListener("click", () => {
      draft = emptyCell();
      $("timeInput").value = "";
      $("titleInput").value = "";
      $("mapInput").value = "";
      renderTagBtns();
    });

    $("saveBtn").addEventListener("click", async () => {
      try{
        if(!editing) return;
        if(!ready){
          alert("FirebaseåˆæœŸåŒ–ä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        await saveCell(editing.date, editing.slotKey, draft);
        closeSheet();
      }catch(e){
        console.error("SAVE FAILED", e);
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n" + (e?.message || e));
      }
    });

    // =====================
    // Boot
    // =====================
    render();

    signInAnonymously(auth).catch((e) => {
      console.error(e);
      alert("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebase Authenticationã§Anonymousã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚");
    });

    onAuthStateChanged(auth, async (user) => {
      if(!user) return;

      await ensureTripDoc();
      ready = true;

      if(unsub) unsub();
      unsub = onSnapshot(tripRef, (snap) => {
        const data = snap.data();
        if(!data) return;
        state.grid = normalizeGrid(data.grid);
        render();
      }, (err) => {
        console.error(err);
        alert("Firestoreè³¼èª­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    });
  </script>
</body>
</html>
    
  </body>
  
</html>
