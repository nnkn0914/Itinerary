<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Itinerary</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</title>
  <style>
    :root{
      --border:#ddd; --bg:#f6f6f6; --text:#111; --muted:#666;
      --black:#111; --white:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:#fff;}
    .app{max-width:720px;margin:0 auto;padding:12px;}

    /* top */
    .topbar{
      position:sticky; top:0; z-index:50; background:#fff;
      padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    h2{margin:0;font-size:20px;line-height:1.2;}
    .sub{margin-top:4px;font-size:12px;color:var(--muted);}
    .tiny{margin-top:6px;font-size:11px;color:var(--muted);line-height:1.2;}

    .mode-btn{
      padding:14px 18px;border:2px solid var(--black);border-radius:16px;
      font-weight:900;cursor:pointer;white-space:nowrap;min-height:48px;font-size:15px;
    }
    .mode-btn:active{transform:translateY(1px);}
    .hint{margin:10px 0 0;font-size:12px;color:var(--muted);}

    /* day/cell */
    .day{border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px;}
    .day strong{font-size:14px;}
    .cell{
      position:relative;background:var(--bg);padding:10px;border-radius:12px;margin-top:8px;cursor:pointer;
    }
    .cell.view{cursor:default;}
    .cellTitle{font-size:13px;line-height:1.35;padding-right:110px;}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
    .chip{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;}
    .chip.all{background:var(--black);color:#fff;border-color:var(--black);}
    .empty{margin-top:16px;font-size:13px;color:var(--muted);}

    /* route badge (å ´æ‰€ãŒã‚ã‚‹äºˆå®šã ã‘ç›®ç«‹ãŸã›ã‚‹) */
    .routeBadge{
      position:absolute;top:8px;right:8px;font-size:12px;padding:7px 10px;border-radius:999px;
      background:var(--black);color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:6px;
      font-weight:900;border:1px solid var(--black);
    }
    .routeBadge:active{transform:translateY(1px);}

    /* sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:80;}
    .sheet{
      position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);
      z-index:90;max-width:720px;margin:0 auto;border-top-left-radius:16px;border-top-right-radius:16px;overflow:hidden;
    }
    .sheet-inner{padding:12px;max-height:58vh;overflow:auto;}
    .sheet-head h4{margin:0;font-size:14px;}
    .input{width:100%;padding:12px;margin-top:10px;border:1px solid var(--border);border-radius:12px;font-size:14px;}
    .tag-label{margin-top:12px;font-size:12px;color:var(--muted);}
    .tag-row{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
    .tag-btn{border:1px solid var(--border);background:#fff;padding:9px 12px;border-radius:999px;font-size:13px;cursor:pointer;white-space:nowrap;}
    .tag-btn.active{background:var(--black);color:#fff;border-color:var(--black);}

    .sheet-actions{
      display:flex;gap:8px;padding:10px 12px 12px;border-top:1px solid rgba(0,0,0,.06);background:#fff;
    }
    .btn{border:1px solid var(--border);background:#fff;border-radius:14px;cursor:pointer;}
    .btn.big{padding:14px 0;font-size:15px;font-weight:900;flex:1;min-width:0;}
    .btn.primary{background:var(--black);color:#fff;border-color:var(--black);flex:1.2;}
    .btn:active{transform:translateY(1px);}

    /* responsive */
    @media (max-width:520px){
      .app{padding:10px;}
      h2{font-size:18px;}
      .mode-btn{padding:14px 14px;font-size:14px;border-radius:14px;}
      .cellTitle{padding-right:96px;}
      .routeBadge{padding:7px 9px;font-size:12px;}
    }
    @media (max-width:380px){
      .sheet-actions{flex-wrap:wrap;}
      .btn.big{flex:1 1 calc(50% - 4px);}
      .btn.primary{flex:1 1 100%;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div>
        <h2>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</h2>
        <div class="sub" id="range"></div>
        <div class="tiny" id="tripInfo" style="display:none;"></div>
      </div>
      <button id="modeBtn" class="mode-btn" type="button">...</button>
    </div>

    <p class="hint" id="hint"></p>
    <div id="root"></div>
    <div class="empty" id="empty" style="display:none;">ã¾ã äºˆå®šãŒå…¥ã£ã¦ã„ã¾ã›ã‚“ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§è¿½åŠ ã§ãã¾ã™ï¼‰</div>
  </div>

  <!-- Edit Sheet -->
  <div class="sheet-backdrop" id="backdrop" style="display:none;"></div>
  <div class="sheet" id="sheet" style="display:none;">
    <div class="sheet-inner">
      <div class="sheet-head">
        <h4 id="sheetTitle"></h4>
      </div>

      <input class="input" id="titleInput" placeholder="äºˆå®šå" />
      <input class="input" id="mapInput" placeholder="å ´æ‰€ï¼ˆGoogle Mapså…±æœ‰ãƒªãƒ³ã‚¯ or ä½æ‰€/åº—å/åº§æ¨™ï¼‰" />

      <div class="tag-label">ã‚¿ã‚°ï¼ˆå…¨å“¡ã‚’é¸ã¶ã¨ä»–ã¯è§£é™¤ï¼‰</div>
      <div class="tag-row" id="tagRow"></div>
    </div>

    <div class="sheet-actions">
      <button class="btn big" id="closeBtn" type="button">é–‰ã˜ã‚‹</button>
      <button class="btn big" id="clearBtn" type="button">ã‚¯ãƒªã‚¢</button>
      <button class="btn big primary" id="saveBtn" type="button">ä¿å­˜</button>
    </div>
  </div>

  <script type="module">
    // =====================
    // Firebase (CDN)
    // =====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // =====================
    // è¨­å®š
    // =====================
    const SLOTS = [
      { key: "am", label: "AM" },
      { key: "pm", label: "PM" },
      { key: "dinner", label: "ãƒ‡ã‚£ãƒŠãƒ¼" },
    ];
    const TAGS = ["å…¨å“¡", "ã‚ã‚“ã±", "ã‚ã‚“ã¾", "ã“ã†ã™ã‘", "ãªãŠ"];

    // âœ… 12/21ã¯å‡ºã•ãªã„ï¼ˆ12/22ã€œ1/9ï¼‰
    const START = "2025-12-22";
    const END   = "2026-01-09";

    // âœ… ã‚ãªãŸã®firebaseConfigï¼ˆå¿…è¦ãªã‚‰å·®ã—æ›¿ãˆï¼‰
const firebaseConfig = {
  apiKey: "AIzaSyCzLFbx3hKRF5fzLb2qEoQb1RjuBKL9L64",
  authDomain: "itinerary-60bec.firebaseapp.com",
  projectId: "itinerary-60bec",
  storageBucket: "itinerary-60bec.firebasestorage.app",
  messagingSenderId: "174617579746",
  appId: "1:174617579746:web:fc1e6d74dd7c7b86a0cebb"
};

    const $ = (id) => document.getElementById(id);

    // =====================
    // æ—¥ä»˜ï¼ˆJSTã‚ºãƒ¬é˜²æ­¢ï¼štoISOString()ã‚’ä½¿ã‚ãªã„ï¼‰
    // =====================
    const pad = (n) => String(n).padStart(2, "0");
    const toLocalISO = (dt) => `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;

    function dateList(startIso, endIso){
      const out=[];
      const d = new Date(startIso + "T00:00:00");
      const end = new Date(endIso + "T00:00:00");
      if (isNaN(d.getTime()) || isNaN(end.getTime())) return out;

      while(true){
        const iso = toLocalISO(d);
        out.push(iso);
        if(iso >= endIso) break;
        d.setDate(d.getDate()+1);
      }
      return out;
    }
    function formatJP(iso){
      const d = new Date(iso + "T00:00:00");
      const w = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()];
      return `${d.getMonth()+1}/${d.getDate()}(${w})`;
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function toMapHref(input){
      const s = String(input || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s; // å…¥åŠ›ãŒURLãªã‚‰ãã‚Œã‚’ä½¿ã†
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s)}`;
    }

    // =====================
    // grid
    // =====================
    function emptyCell(){ return { title:"", tags:["å…¨å“¡"], map:"" }; }

    function makeGrid(){
      const g = {};
      dateList(START, END).forEach(date => {
        g[date] = {};
        SLOTS.forEach(s => g[date][s.key] = emptyCell());
      });
      return g;
    }
    function normalizeGrid(grid){
      const g = makeGrid();
      if(!grid || typeof grid !== "object") return g;

      Object.keys(g).forEach(date => {
        SLOTS.forEach(s => {
          const c = grid?.[date]?.[s.key];
          if(!c) return;

          let tags = Array.isArray(c.tags) && c.tags.length ? c.tags.map(String) : ["å…¨å“¡"];
          tags = tags.filter(t => TAGS.includes(t));
          if(!tags.length) tags = ["å…¨å“¡"];
          if(tags.includes("å…¨å“¡") && tags.length > 1) tags = ["å…¨å“¡"];

          g[date][s.key] = {
            title: String(c.title || ""),
            map: String(c.map || ""),
            tags
          };
        });
      });
      return g;
    }

    // =====================
    // tripId (URL param) : å…±æœ‰ã¯ã€ŒåŒã˜URLã€ã§å®Ÿç¾
    // =====================
    function randomTripId(){
      // __ ã‚’é¿ã‘ã‚‹ï¼ˆäºˆç´„èªå›é¿ï¼‰
      return "t" + Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,6);
    }
    function getOrCreateTripId(){
      const u = new URL(location.href);
      let trip = u.searchParams.get("trip");
      if(!trip){
        trip = randomTripId();
        u.searchParams.set("trip", trip);
        history.replaceState(null, "", u.toString());
      }
      return trip;
    }
    const tripId = getOrCreateTripId();

    // UI info
    $("range").textContent = `${formatJP(START)} ã€œ ${formatJP(END)}`;
    // å…±æœ‰æƒ…å ±ã¯æ§ãˆã‚ã«ï¼ˆãƒœã‚¿ãƒ³ã¯å‡ºã•ãªã„ï¼‰
    $("tripInfo").style.display = "block";
    $("tripInfo").textContent = `ã“ã®URLã‚’å…±æœ‰ã™ã‚‹ã¨åŒã˜äºˆå®šãŒè¦‹ãˆã¾ã™ï¼ˆID: ${tripId}ï¼‰`;

    // =====================
    // Firebase init
    // =====================
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const tripRef = doc(db, "trips", tripId);

    // =====================
    // stateï¼ˆFirestoreãŒæ­£ï¼‰
    // =====================
    let state = { grid: makeGrid(), mode: "edit" };
    let editing = null;
    let draft = emptyCell();
    let unsub = null;

    // =====================
    // UI
    // =====================
    function setModeBtn(mode){
      const b = $("modeBtn");
      const isView = mode === "view";

      // âœ… è¦æœ›ï¼šå…¥åŠ›ã§ãã‚‹ç”»é¢(=edit)ã§ã¯ã€Œé–²è¦§ãƒ¢ãƒ¼ãƒ‰ã¸ã€ãƒœã‚¿ãƒ³
      // âœ… äºˆå®šã ã‘è¡¨ç¤º(=view)ã§ã¯ã€Œç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸ã€ãƒœã‚¿ãƒ³
      b.textContent = isView ? "âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸" : "ğŸ“– é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã¸";

      if(isView){
        // viewç”»é¢ã¯ç™½ãƒœã‚¿ãƒ³ï¼ˆç·¨é›†ã¸ï¼‰
        b.style.background = "#fff";
        b.style.color = "#111";
        b.style.border = "2px solid #111";
      }else{
        // editç”»é¢ã¯é»’ãƒœã‚¿ãƒ³ï¼ˆé–²è¦§ã¸ï¼‰
        b.style.background = "#111";
        b.style.color = "#fff";
        b.style.border = "2px solid #111";
      }
    }

    function renderChips(tags){
      const d = document.createElement("div");
      d.className = "chips";
      (Array.isArray(tags) ? tags : []).forEach(t => {
        const s = document.createElement("span");
        s.className = "chip" + (t === "å…¨å“¡" ? " all" : "");
        s.textContent = t;
        d.appendChild(s);
      });
      return d;
    }

    function render(){
      const isView = state.mode === "view";
      setModeBtn(state.mode);

      $("hint").textContent = isView
        ? "äºˆå®šãŒå…¥ã£ã¦ã„ã‚‹æ ã ã‘è¡¨ç¤ºã—ã¾ã™"
        : "ã‚¿ãƒƒãƒ—ã—ã¦äºˆå®šã‚’å…¥åŠ›ï¼ˆå…¨å“¡ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰ï¼‰";

      const root = $("root");
      root.innerHTML = "";
      let any = false;

      dateList(START, END).forEach(date => {
        const day = document.createElement("div");
        day.className = "day";
        day.innerHTML = `<strong>${formatJP(date)}</strong>`;

        let hasDay = false;

        if(isView){
          // view: äºˆå®šãŒã‚ã‚‹æ ã ã‘ï¼ˆAMâ†’PMâ†’ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰
          SLOTS.forEach(s => {
            const c = state.grid[date][s.key];
            const has = (c.title && c.title.trim()) || (c.map && c.map.trim());
            if(!has) return;

            hasDay = true;
            any = true;

            const cell = document.createElement("div");
            cell.className = "cell view";

            if(c.map && c.map.trim()){
              const a = document.createElement("a");
              a.className = "routeBadge";
              a.href = toMapHref(c.map);
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.textContent = "ğŸ“ãƒ«ãƒ¼ãƒˆæ¤œç´¢";
              a.addEventListener("click", (e) => e.stopPropagation());
              cell.appendChild(a);
            }

            const t = document.createElement("div");
            t.className = "cellTitle";
            t.innerHTML = `<strong>${s.label}</strong>ï¼š${c.title ? escapeHtml(c.title) : ""}`;
            cell.appendChild(t);
            cell.appendChild(renderChips(c.tags));

            day.appendChild(cell);
          });

          if(hasDay) root.appendChild(day);
          return;
        }

        // edit: å…¨æ å‡ºã™ï¼ˆAM/PM/ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰
        any = true;
        SLOTS.forEach(s => {
          const c = state.grid[date][s.key];

          const cell = document.createElement("div");
          cell.className = "cell";
          cell.addEventListener("click", () => openEdit(date, s.key));

          if(c.map && c.map.trim()){
            const a = document.createElement("a");
            a.className = "routeBadge";
            a.href = toMapHref(c.map);
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "ğŸ“ãƒ«ãƒ¼ãƒˆæ¤œç´¢";
            a.addEventListener("click", (e) => e.stopPropagation());
            cell.appendChild(a);
          }

          const t = document.createElement("div");
          t.className = "cellTitle";
          t.innerHTML = `<strong>${s.label}</strong>ï¼š${c.title ? escapeHtml(c.title) : "ï¼‹ è¿½åŠ "}`;
          cell.appendChild(t);
          cell.appendChild(renderChips(c.tags));

          day.appendChild(cell);
        });

        root.appendChild(day);
      });

      // viewã§ä½•ã‚‚ãªã„å ´åˆ
      $("empty").style.display = (state.mode === "view" && !any) ? "block" : "none";
      if(state.mode === "view"){
        // viewã¯ â€œäºˆå®šãŒ1ã¤ã‚‚ãªã„â€ ã‹ã©ã†ã‹ã§åˆ¤å®šã—ç›´ã™
        let count = 0;
        dateList(START, END).forEach(date => {
          SLOTS.forEach(s => {
            const c = state.grid[date][s.key];
            if ((c.title && c.title.trim()) || (c.map && c.map.trim())) count++;
          });
        });
        $("empty").style.display = count ? "none" : "block";
      }
    }

    // =====================
    // Sheet
    // =====================
    function renderTagBtns(){
      const row = $("tagRow");
      row.innerHTML = "";
      TAGS.forEach(t => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "tag-btn" + (draft.tags.includes(t) ? " active" : "");
        b.textContent = t;
        b.onclick = () => {
          if(t === "å…¨å“¡"){
            draft.tags = ["å…¨å“¡"];
          }else{
            draft.tags = draft.tags.filter(x => x !== "å…¨å“¡");
            if(draft.tags.includes(t)) draft.tags = draft.tags.filter(x => x !== t);
            else draft.tags.push(t);
            if(!draft.tags.length) draft.tags = ["å…¨å“¡"];
          }
          renderTagBtns();
        };
        row.appendChild(b);
      });
    }

    function openEdit(date, slot){
      editing = { date, slot };
      const c = state.grid[date][slot];
      draft = { title: c.title, map: c.map, tags: [...c.tags] };

      $("sheetTitle").textContent = `${formatJP(date)} / ${SLOTS.find(x => x.key === slot).label}`;
      $("titleInput").value = draft.title;
      $("mapInput").value = draft.map;

      renderTagBtns();
      $("backdrop").style.display = "block";
      $("sheet").style.display = "block";
    }

    function closeSheet(){
      $("backdrop").style.display = "none";
      $("sheet").style.display = "none";
      editing = null;
    }

    $("closeBtn").addEventListener("click", closeSheet);
    $("backdrop").addEventListener("click", closeSheet);
    $("titleInput").addEventListener("input", (e) => (draft.title = e.target.value));
    $("mapInput").addEventListener("input", (e) => (draft.map = e.target.value));

    $("clearBtn").addEventListener("click", () => {
      draft = emptyCell();
      $("titleInput").value = "";
      $("mapInput").value = "";
      renderTagBtns();
    });

    // =====================
    // Firestore
    // =====================
    async function ensureTripDoc(){
      const snap = await getDoc(tripRef);
      if(!snap.exists()){
        await setDoc(tripRef, {
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          mode: "edit",
          grid: makeGrid(),
        });
      }
    }

    async function saveCell(date, slotKey, payload){
      const base = `grid.${date}.${slotKey}`;
      const update = {};
      update[`${base}.title`] = payload.title;
      update[`${base}.map`]   = payload.map;
      update[`${base}.tags`]  = payload.tags;
      update["updatedAt"] = serverTimestamp();
      await updateDoc(tripRef, update);
    }

    async function setMode(mode){
      state.mode = mode;
      render();
      await updateDoc(tripRef, { mode, updatedAt: serverTimestamp() });
    }

    $("saveBtn").addEventListener("click", async () => {
      if(!editing) return;

      const title = String($("titleInput").value || "").trim();
      const map   = String($("mapInput").value || "").trim();
      let tags = Array.isArray(draft.tags) && draft.tags.length ? draft.tags : ["å…¨å“¡"];
      if(tags.includes("å…¨å“¡") && tags.length > 1) tags = ["å…¨å“¡"];

      const { date, slot } = editing;
      closeSheet();
      await saveCell(date, slot, { title, map, tags });
    });

    $("modeBtn").addEventListener("click", async () => {
      closeSheet();
      const next = state.mode === "view" ? "edit" : "view";
      await setMode(next);
    });

    // =====================
    // èµ·å‹•ï¼šåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ â†’ docæº–å‚™ â†’ è³¼èª­
    // =====================
    signInAnonymously(auth).catch((e) => {
      console.error(e);
      alert("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebase Authenticationã§Anonymousã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚");
    });

    onAuthStateChanged(auth, async (user) => {
      if(!user) return;

      await ensureTripDoc();

      if(unsub) unsub();
      unsub = onSnapshot(tripRef, (snap) => {
        const data = snap.data();
        if(!data) return;

        state.mode = data.mode === "view" ? "view" : "edit";
        state.grid = normalizeGrid(data.grid);
        render();
      }, (err) => {
        console.error(err);
        alert("Firestoreè³¼èª­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    });
  </script>
</body>
</html>
    
  </body>
  
</html>
