<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Itinerary</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ÊóÖË°å„Çπ„Ç±„Ç∏„É•„Éº„É´üå¥</title>
<style>
  :root{
    --border:#ddd; --bg:#f6f6f6; --text:#111; --muted:#666; --black:#111;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:#fff;}
  .app{max-width:760px;margin:0 auto;padding:12px;}

  h2{margin:0;font-size:20px;line-height:1.2;}
  .sub{margin-top:4px;font-size:12px;color:var(--muted);}
  .hint{margin-top:8px;font-size:12px;color:var(--muted);}

  .topbar{
    position:sticky; top:0; z-index:50; background:#fff;
    padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06);
  }

  .day{border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px;}
  .day strong{font-size:14px;}

  .slot{margin-top:10px;}
  .slotLabel{font-size:12px;font-weight:900;color:#333;margin-bottom:6px;}

  /* „É°„Ç§„É≥Ôºö1Ë°å„Ç≥„É≥„Éë„ÇØ„Éà */
  .row{
    display:flex; align-items:center; gap:8px;
    padding:6px 8px; border-radius:12px; background:var(--bg);
    margin-top:6px; cursor:pointer;
  }
  .row.empty{opacity:.55; padding:6px 8px;}
  .time{font-weight:900;font-variant-numeric:tabular-nums; white-space:nowrap; font-size:12px;}
  .title{flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px;}
  .tags{display:flex; gap:4px; flex-wrap:nowrap;}
  .tag{
    font-size:10px; padding:2px 6px; border-radius:999px;
    border:1px solid var(--border); background:#fff; white-space:nowrap;
  }
  .tag.all{background:#111;color:#fff;border-color:#111;}

  .route{
    font-size:11px; padding:5px 9px; border-radius:999px;
    background:#111; color:#fff; text-decoration:none; white-space:nowrap;
    display:inline-flex; align-items:center; gap:6px; font-weight:900;
  }
  .route:active{transform:translateY(1px);}

  /* bottom sheet */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:80; display:none;}
  .sheet{
    position:fixed; left:0; right:0; bottom:0;
    background:#fff; border-top:1px solid var(--border);
    border-radius:16px 16px 0 0;
    max-width:760px; margin:0 auto;
    z-index:90; display:none;
  }
  .sheetInner{padding:12px; max-height:62vh; overflow:auto;}
  .sheetHead{display:flex; align-items:center; justify-content:space-between; gap:8px;}
  .sheetHead h4{margin:0; font-size:14px;}

  .addBtn{
    font-size:12px; font-weight:900;
    border:1px solid var(--border);
    padding:8px 12px; border-radius:999px; background:#fff;
    cursor:pointer; display:none;
  }
  .addBtn:active{transform:translateY(1px);}

  .setBox{border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:10px; margin-top:10px; background:#fff;}
  .setTop{display:flex; align-items:center; justify-content:space-between; gap:8px;}
  .setTitle{font-size:12px; font-weight:900; color:#333;}
  .delBtn{
    border:1px solid #e5b3b3; color:#b00020; background:#fff;
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
    cursor:pointer;
  }

  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;}
  .label{font-size:12px; color:var(--muted); margin-top:10px;}
  .input{
    width:100%; padding:10px; border:1px solid var(--border);
    border-radius:12px; font-size:14px; margin-top:6px;
  }

  .tagRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
  .tagBtn{
    border:1px solid var(--border); background:#fff; padding:8px 12px;
    border-radius:999px; font-size:12px; font-weight:900; cursor:pointer;
  }
  .tagBtn.active{background:#111;color:#fff;border-color:#111;}

  .actions{display:flex; gap:8px; padding:10px 12px 12px; border-top:1px solid rgba(0,0,0,.06);}
  .btn{
    flex:1; padding:14px 0; border-radius:14px; border:1px solid var(--border);
    background:#fff; font-weight:900; font-size:15px; cursor:pointer;
  }
  .btn.primary{background:#111;color:#fff;border-color:#111; flex:1.2;}
  .btn:active{transform:translateY(1px);}

  @media (max-width:520px){
    h2{font-size:18px;}
    .row2{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h2>ÊóÖË°å„Çπ„Ç±„Ç∏„É•„Éº„É´üå¥</h2>
    <div class="sub" id="range"></div>
    <div class="hint">„Çø„ÉÉ„Éó„Åó„Å¶Á∑®ÈõÜÔºàÂêåÊôÇÁ∑®ÈõÜ„ÉªËá™Âãï‰øùÂ≠òÔºâ</div>
  </div>
  <div id="root"></div>
</div>

<div class="backdrop" id="backdrop"></div>
<div class="sheet" id="sheet">
  <div class="sheetInner">
    <div class="sheetHead">
      <h4 id="sheetTitle"></h4>
      <button class="addBtn" id="addBtn" type="button">Ôºã‰∫àÂÆö„ÇíËøΩÂä†</button>
    </div>
    <div id="editor"></div>
  </div>
  <div class="actions">
    <button class="btn" id="closeBtn" type="button">Èñâ„Åò„Çã</button>
    <button class="btn primary" id="saveBtn" type="button">‰øùÂ≠ò</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // ===== Ë®≠ÂÆö =====
  const SLOTS=[{key:"am",label:"AM"},{key:"pm",label:"PM"},{key:"dinner",label:"„Éá„Ç£„Éä„Éº"}];
  const TAGS=["All","„ÅÇ„Çì„Å±","„ÅÇ„Çì„Åæ","„Åì„ÅÜ„Åô„Åë","„Å™„Åä"];
  const START="2025-12-22";
  const END="2026-01-09";

  // ‚ö†Ô∏è „ÅÇ„Å™„Åü„ÅÆÂÄ§„Å´Â∑Æ„ÅóÊõø„Åà
const firebaseConfig = {
  apiKey: "AIzaSyCzLFbx3hKRF5fzLb2qEoQb1RjuBKL9L64",
  authDomain: "itinerary-60bec.firebaseapp.com",
  projectId: "itinerary-60bec",
  storageBucket: "itinerary-60bec.firebasestorage.app",
  messagingSenderId: "174617579746",
  appId: "1:174617579746:web:fc1e6d74dd7c7b86a0cebb"
};

  const $ = (id)=>document.getElementById(id);

  // ===== utils =====
  const pad=n=>String(n).padStart(2,"0");
  const toISO=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function dateList(){
    const out=[];
    const d=new Date(START+"T00:00:00");
    while(true){
      const iso=toISO(d);
      out.push(iso);
      if(iso>=END) break;
      d.setDate(d.getDate()+1);
    }
    return out;
  }
  function formatJP(iso){
    const d=new Date(iso+"T00:00:00");
    const w="Êó•ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúü"[d.getDay()];
    return `${d.getMonth()+1}/${d.getDate()}(${w})`;
  }
  function mapHref(v){
    const s=String(v||"").trim();
    if(!s) return "";
    if(/^https?:\/\//i.test(s)) return s;
    return "https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(s);
  }
  function id(){
    return "i"+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,6);
  }

  // ===== data =====
  const emptyItem = ()=>({id:id(), time:"", title:"", map:"", tags:[]});
  function makeGrid(){
    const g={};
    for(const d of dateList()){
      g[d]={};
      for(const s of SLOTS) g[d][s.key]=[];
    }
    return g;
  }
  function cleanTags(tags){
    let t = Array.isArray(tags) ? tags.filter(x=>TAGS.includes(x)) : [];
    return t.includes("All") ? ["All"] : t;
  }
  function normalizeGrid(raw){
    const g=makeGrid();
    if(!raw || typeof raw!=="object") return g;

    for(const d of Object.keys(g)){
      for(const s of SLOTS){
        const v = raw?.[d]?.[s.key];

        // ÊóßÔºöÂçò‰ΩìÂΩ¢Âºè„ÇÇÂê∏Âèé
        if(v && typeof v==="object" && !Array.isArray(v) && ("time" in v || "title" in v || "map" in v)){
          const one = {
            id:id(),
            time:String(v.time||""),
            title:String(v.title||""),
            map:String(v.map||""),
            tags:cleanTags(v.tags)
          };
          const ok = (one.time.trim()||one.title.trim()||one.map.trim()||one.tags.length);
          g[d][s.key] = ok ? [one] : [];
          continue;
        }

        // Êñ∞ÔºöÈÖçÂàóÂΩ¢Âºè
        if(Array.isArray(v)){
          g[d][s.key] = v.map(x=>({
            id:String(x?.id||id()),
            time:String(x?.time||""),
            title:String(x?.title||""),
            map:String(x?.map||""),
            tags:cleanTags(x?.tags)
          })).filter(it => (it.time.trim()||it.title.trim()||it.map.trim()||it.tags.length));
        }
      }
    }
    return g;
  }

  // ===== tripId =====
  function getTripId(){
    const u=new URL(location.href);
    let t=u.searchParams.get("trip");
    if(!t){
      t="t"+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,6);
      u.searchParams.set("trip", t);
      history.replaceState(null,"",u.toString());
    }
    return t;
  }
  const tripId = getTripId();

  $("range").textContent = `${formatJP(START)} „Äú ${formatJP(END)}`;

  // ===== Firebase =====
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const tripRef = doc(db, "trips", tripId);

  // ===== state =====
  let state = { grid: makeGrid() };
  let editing = null;        // {date, slotKey}
  let draftItems = [];       // Á∑®ÈõÜÁîªÈù¢Áî®ÔºàË§áÊï∞Ôºâ
  let ready=false;

  // ===== Firestore =====
  async function ensureDoc(){
    const snap = await getDoc(tripRef);
    if(!snap.exists()){
      await setDoc(tripRef, { grid: makeGrid(), createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
    }
  }
  async function saveSlot(date, slotKey, items){
    const cleaned = (items||[]).map(x=>({
      id: String(x.id || id()),
      time: String(x.time||"").trim(),
      title: String(x.title||"").trim(),
      map: String(x.map||"").trim(),
      tags: cleanTags(x.tags)
    })).filter(it => (it.time||it.title||it.map||it.tags.length));

    const update = {};
    update[`grid.${date}.${slotKey}`] = cleaned;
    update["updatedAt"] = serverTimestamp();
    await updateDoc(tripRef, update);
  }

  // ===== Main UI =====
  function renderMain(){
    const root=$("root");
    root.innerHTML="";

    for(const d of dateList()){
      const day=document.createElement("div");
      day.className="day";
      day.innerHTML = `<strong>${formatJP(d)}</strong>`;

      for(const s of SLOTS){
        const items = state.grid?.[d]?.[s.key] || [];

        const slot=document.createElement("div");
        slot.className="slot";

        const label=document.createElement("div");
        label.className="slotLabel";
        label.textContent = s.label;
        slot.appendChild(label);

        if(!items.length){
          const row=document.createElement("div");
          row.className="row empty";
          row.innerHTML = `<span class="title">Ôºã ËøΩÂä†</span>`;
          row.onclick = ()=>openEditor(d, s.key);
          slot.appendChild(row);
        }else{
          items.forEach(it=>{
            const row=document.createElement("div");
            row.className="row";
            row.onclick = ()=>openEditor(d, s.key);

            const time=document.createElement("span");
            time.className="time";
            time.textContent = it.time ? it.time : "--:--";

            const title=document.createElement("span");
            title.className="title";
            title.textContent = it.title || "";

            row.appendChild(time);
            row.appendChild(title);

            if(String(it.map||"").trim()){
              const a=document.createElement("a");
              a.className="route";
              a.href = mapHref(it.map);
              a.target="_blank";
              a.rel="noopener noreferrer";
              a.textContent="üìç„É´„Éº„ÉàÊ§úÁ¥¢";
              a.onclick = (e)=>e.stopPropagation();
              row.appendChild(a);
            }

            const tags=document.createElement("span");
            tags.className="tags";
            (it.tags||[]).forEach(t=>{
              const sp=document.createElement("span");
              sp.className="tag"+(t==="All"?" all":"");
              sp.textContent=t;
              tags.appendChild(sp);
            });
            row.appendChild(tags);

            slot.appendChild(row);
          });
        }

        day.appendChild(slot);
      }

      root.appendChild(day);
    }
  }

  // ===== Editor UI =====
  function openEditor(date, slotKey){
    editing = {date, slotKey};
    const slotLabel = SLOTS.find(x=>x.key===slotKey)?.label || slotKey;
    $("sheetTitle").textContent = `${formatJP(date)} / ${slotLabel}`;

    const cur = state.grid?.[date]?.[slotKey] || [];
    draftItems = cur.length
      ? cur.map(x=>({ ...x, tags: Array.isArray(x.tags)? [...x.tags] : [] }))
      : [ emptyItem() ];

    // ‚úÖ Êó¢„Å´1„Çª„ÉÉ„ÉàÂÖ•„Å£„Å¶„ÅÑ„ÇãÊôÇ„Å†„ÅëË°®Á§∫
    $("addBtn").style.display = (cur.length >= 1) ? "inline-block" : "none";

    renderEditor();

    $("backdrop").style.display="block";
    $("sheet").style.display="block";
  }

  function closeEditor(){
    $("backdrop").style.display="none";
    $("sheet").style.display="none";
    editing=null;
    draftItems=[];
  }

  function renderEditor(){
    const box=$("editor");
    box.innerHTML="";
    draftItems.forEach((it, idx)=>{
      box.appendChild(itemEditor(it, idx));
    });
  }

  // ‚úÖ „Çø„Ç∞„ÅßÂÜçÊèèÁîª„Åó„Å™„ÅÑÁâàÔºàÂÖ•Âäõ„ÅåÊ∂à„Åà„Å™„ÅÑÔºâ
  function itemEditor(it, idx){
    const wrap=document.createElement("div");
    wrap.className="setBox";

    const head=document.createElement("div");
    head.className="setTop";

    const st=document.createElement("div");
    st.className="setTitle";
    st.textContent = `‰∫àÂÆö ${idx+1}`;
    head.appendChild(st);

    if(draftItems.length > 1){
      const del=document.createElement("button");
      del.type="button";
      del.className="delBtn";
      del.textContent="ÂâäÈô§";
      del.onclick=()=>{
        const i = draftItems.findIndex(x=>x.id===it.id);
        if(i>=0){
          draftItems.splice(i,1);
          $("addBtn").style.display = (draftItems.length >= 1) ? "inline-block" : "none";
          renderEditor(); // ÂâäÈô§„ÅØÂÜçÊèèÁîªOK
        }
      };
      head.appendChild(del);
    }
    wrap.appendChild(head);

    const row2=document.createElement("div");
    row2.className="row2";

    const time=document.createElement("input");
    time.type="time";
    time.className="input";
    time.value = it.time || "";
    time.oninput = (e)=>{ it.time = e.target.value; };

    const title=document.createElement("input");
    title.className="input";
    title.placeholder="‰∫àÂÆöÂêç";
    title.value = it.title || "";
    title.oninput = (e)=>{ it.title = e.target.value; };

    row2.appendChild(time);
    row2.appendChild(title);
    wrap.appendChild(row2);

    const l1=document.createElement("div");
    l1.className="label";
    l1.textContent="Â†¥ÊâÄÔºàGoogle Maps„É™„É≥„ÇØ or ‰ΩèÊâÄ/Â∫óÂêçÔºâ";
    wrap.appendChild(l1);

    const map=document.createElement("input");
    map.className="input";
    map.placeholder="‰æãÔºö„Éõ„ÉÜ„É´Âêç / Ê∏ãË∞∑ÈßÖ / https://maps.app.goo.gl/...";
    map.value = it.map || "";
    map.oninput = (e)=>{ it.map = e.target.value; };
    wrap.appendChild(map);

    const l2=document.createElement("div");
    l2.className="label";
    l2.textContent="„Çø„Ç∞ÔºàAll„ÅØ‰ªñ„Å®ÂêåÊôÇÈÅ∏Êäû‰∏çÂèØÔºâ";
    wrap.appendChild(l2);

    const tagRow=document.createElement("div");
    tagRow.className="tagRow";

    TAGS.forEach(t=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="tagBtn"+((it.tags||[]).includes(t)?" active":"");
      b.textContent=t;

      b.onclick=()=>{
        it.tags = Array.isArray(it.tags) ? it.tags : [];

        if(t==="All"){
          it.tags=["All"];
          [...tagRow.children].forEach(btn=>{
            btn.classList.toggle("active", btn.textContent==="All");
          });
        }else{
          it.tags = it.tags.filter(x=>x!=="All");
          if(it.tags.includes(t)){
            it.tags = it.tags.filter(x=>x!==t);
            b.classList.remove("active");
          }else{
            it.tags.push(t);
            b.classList.add("active");
          }
          // All„Å†„ÅëOFF
          [...tagRow.children].forEach(btn=>{
            if(btn.textContent==="All") btn.classList.remove("active");
          });
        }
      };

      tagRow.appendChild(b);
    });

    wrap.appendChild(tagRow);
    return wrap;
  }

  // ‚úÖ Êó¢„Å´1„Çª„ÉÉ„ÉàÂÖ•„Å£„Å¶„ÅÑ„ÇãÊôÇ„Å†„ÅëË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã
  $("addBtn").addEventListener("click", ()=>{
    draftItems.push(emptyItem());
    renderEditor(); // ËøΩÂä†„ÅØÂÜçÊèèÁîªOK
  });

  $("backdrop").addEventListener("click", closeEditor);
  $("closeBtn").addEventListener("click", closeEditor);

  $("saveBtn").addEventListener("click", async ()=>{
    try{
      if(!editing) return;
      if(!ready){
        alert("ÂàùÊúüÂåñ‰∏≠„Åß„Åô„ÄÇÊï∞ÁßíÂæÖ„Å£„Å¶„Åã„Çâ‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        return;
      }
      await saveSlot(editing.date, editing.slotKey, draftItems);
      closeEditor();
    }catch(e){
      console.error(e);
      alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:\n" + (e?.message || e));
    }
  });

  // ===== boot =====
  renderMain();

  signInAnonymously(auth).catch((e)=>{
    console.error(e);
    alert("ÂåøÂêç„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇFirebase Authentication„ÅßAnonymous„ÇíON„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;

    await ensureDoc();
    ready=true;

    onSnapshot(tripRef, (snap)=>{
      const data = snap.data();
      if(!data) return;
      state.grid = normalizeGrid(data.grid);
      renderMain();
    }, (err)=>{
      console.error(err);
      alert("FirestoreË≥ºË™≠„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„É´„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    });
  });
</script>
</body>
</html>
    
  </body>
  
</html>
