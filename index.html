<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Itinerary</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¹¸ã›ãƒãƒ¯ã‚¤è¨ˆç”»ğŸŒ´</title>
<style>
  :root{
    --border:#ddd; --bg:#f6f6f6; --text:#111; --muted:#666; --black:#111;
    --ok:#0b7a2a;

    /* fab color (é»’ä»¥å¤–) */
    --fab:#1e66ff;        /* ãƒ–ãƒ«ãƒ¼ */
    --fabShadow: rgba(30,102,255,.28);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:#fff;}
  .app{max-width:860px;margin:0 auto;padding:12px; padding-bottom:84px;}

  h2{margin:0;font-size:20px;line-height:1.2;}
  .sub{margin-top:4px;font-size:12px;color:var(--muted);}
  .hint{margin-top:8px;font-size:12px;color:var(--muted);}

  .topbar{
    position:sticky; top:0; z-index:50; background:#fff;
    padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06);
  }

  .nav{display:flex; gap:8px; align-items:center; justify-content:flex-end;}
  .tabs{display:flex; gap:8px; align-items:center;}
  .tab{
    border:1px solid var(--border);
    background:#fff;
    padding:10px 12px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-size:13px;
  }
  .tab.active{background:#111;color:#fff;border-color:#111;}
  .tab:active{transform:translateY(1px)}
  .tab .icon{font-size:14px; line-height:1; opacity:.9;}

  /* schedule cards */
  .day{border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px;}
  .day strong{font-size:14px;}

  .slot{margin-top:10px;}
  .slotLabel{font-size:12px;font-weight:900;color:#333;margin-bottom:6px;}

  /* row (schedule & book item unified look) */
  .row{
    display:flex; align-items:center; gap:8px;
    padding:6px 8px; border-radius:12px; background:var(--bg);
    margin-top:6px; cursor:pointer;
  }
  .row.empty{opacity:.55; padding:6px 8px;}
  .time{font-weight:900;font-variant-numeric:tabular-nums;white-space:nowrap;font-size:12px;width:56px;flex:0 0 auto;}
  .main{display:flex;align-items:center;gap:8px;min-width:0;flex:1 1 auto;}
  .title{min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;flex:0 1 auto;}
  .tags{display:flex;gap:4px;flex:0 0 auto;flex-wrap:nowrap;overflow:hidden;max-width:240px;}
  .tag{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#fff;white-space:nowrap;color:#111;}

  .route{
    font-size:11px;padding:5px 9px;border-radius:999px;background:#111;color:#fff;text-decoration:none;
    white-space:nowrap;display:inline-flex;align-items:center;gap:6px;font-weight:900;margin-left:auto;flex:0 0 auto;
  }
  .route:active{transform:translateY(1px);}

  /* booklist */
  .bookHead{display:flex; align-items:flex-end; justify-content:space-between; gap:8px; margin-top:10px;}
  .bookTitle{font-weight:900;font-size:16px;margin:0;}
  .bookSub{font-size:12px;color:var(--muted);margin-top:4px;}

  /* âœ… ã‚«ãƒ†ã‚´ãƒªèƒŒæ™¯ã¯ç™½ã«æˆ»ã™ */
  .bookSection{
    margin-top:14px;
    border:1px solid rgba(0,0,0,.06);
    border-radius:14px;
    padding:10px;
    background:#fff;
  }
  .bookSectionTitle{
    font-weight:900;
    font-size:13px;
    margin:0 0 6px 0;
    color:#333;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }

  /* âœ… ãƒ–ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ã‚¢ã‚¤ãƒ†ãƒ ï¼šæ ç·šãªã—è–„ã‚°ãƒ¬ãƒ¼ã€ç¸¦å¹…å°ã•ã */
  .bookItem{
    display:flex; align-items:center; gap:8px;
    padding:6px 8px;
    border-radius:12px;
    background:var(--bg);   /* schedule row ã¨åŒã˜ */
    margin-top:8px;
    cursor:pointer;
    border:none;            /* æ ç·šãªã— */
  }
  .bookLeft{min-width:0; flex:1 1 auto;}
  .bookName{
    font-weight:900;
    font-size:13px;          /* å°‘ã—å°ã•ã */
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    line-height:1.2;
  }

  .badge{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    color:#111;
    white-space:nowrap;
    line-height:1.2;
    display:inline-flex;
    align-items:center;
  }
  .badge.ok{
    border-color:rgba(11,122,42,.3);
    background:rgba(11,122,42,.08);
    color:var(--ok);
    font-weight:900;
  }

  /* âœ… åœ°å›³ãƒœã‚¿ãƒ³ã‚’å°ã•ããƒ»ç¸¦å¹…ã‚’äºˆå®šæ¸ˆãƒãƒƒã‚¸ã¨æƒãˆã‚‹ */
  .miniLink{
    font-size:11px;
    font-weight:900;
    padding:3px 8px;         /* badgeã¨åŒã˜é«˜ã•æ„Ÿ */
    border-radius:999px;
    border:1px solid var(--border);
    background:#111;
    color:#fff;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:6px;
    line-height:1.2;
    flex:0 0 auto;
  }
  .miniLink:active{transform:translateY(1px)}

  /* âœ… Floating + button */
  .fab{
    position:fixed;
    right:16px;
    bottom:18px;
    width:56px;
    height:56px;
    border-radius:999px;
    border:none;
    background:var(--fab);
    color:#fff;
    font-size:30px;
    font-weight:900;
    display:none; /* booklistæ™‚ã ã‘ */
    align-items:center;
    justify-content:center;
    box-shadow:0 10px 24px var(--fabShadow);
    cursor:pointer;
    z-index:70;
  }
  .fab:active{transform:translateY(1px);}

  /* bottom sheet */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:80; display:none;}
  .sheet{
    position:fixed; left:0; right:0; bottom:0;
    background:#fff; border-top:1px solid var(--border);
    border-radius:16px 16px 0 0;
    max-width:860px; margin:0 auto;
    z-index:90; display:none;
  }
  .sheetInner{padding:12px; max-height:65vh; overflow:auto;}
  .sheetHead{display:flex; align-items:center; justify-content:space-between; gap:8px;}
  .sheetHead h4{margin:0; font-size:14px;}

  .addBtn{
    font-size:12px; font-weight:900;
    border:1px solid var(--border);
    padding:8px 12px; border-radius:999px; background:#fff;
    cursor:pointer; display:none; /* scheduleå´ã®è¤‡æ•°äºˆå®šç”¨ */
  }
  .addBtn:active{transform:translateY(1px);}

  .setBox{border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:10px; margin-top:10px; background:#fff;}
  .setTop{display:flex; align-items:center; justify-content:space-between; gap:8px;}
  .setTitle{font-size:12px; font-weight:900; color:#333;}
  .delBtn{
    border:1px solid #e5b3b3; color:#b00020; background:#fff;
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
    cursor:pointer;
  }

  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;}
  .label{font-size:12px; color:var(--muted); margin-top:10px;}
  .input{
    width:100%; padding:10px; border:1px solid var(--border);
    border-radius:12px; font-size:14px; margin-top:6px;
  }
  select.input{appearance:auto;}

  .tagRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
  .tagBtn{
    border:1px solid var(--border); background:#fff; padding:8px 12px;
    border-radius:999px; font-size:12px; font-weight:900; cursor:pointer;
  }
  .tagBtn.active{background:#111;color:#fff;border-color:#111;}

  .actions{display:flex; gap:8px; padding:10px 12px 12px; border-top:1px solid rgba(0,0,0,.06);}
  .btn{
    flex:1; padding:14px 0; border-radius:14px; border:1px solid var(--border);
    background:#fff; font-weight:900; font-size:15px; cursor:pointer;
  }
  .btn.primary{background:#111;color:#fff;border-color:#111; flex:1.2;}
  .btn.danger{border-color:#f0b8b8; color:#b00020;}
  .btn:active{transform:translateY(1px);}

  @media (max-width:560px){
    h2{font-size:18px;}
    .row2{grid-template-columns:1fr;}
    .tags{max-width:160px;}
    .tab{padding:9px 10px; font-size:12px;}
    .fab{right:14px; bottom:16px; width:54px; height:54px;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="nav">
      <div class="tabs">
        <button class="tab active" id="tabSchedule" type="button"><span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span><span class="icon">ğŸ—“ï¸</span></button>
        <button class="tab" id="tabBook" type="button"><span>ãƒ–ãƒƒã‚¯ãƒªã‚¹ãƒˆ</span><span class="icon">ğŸ“š</span></button>
      </div>
    </div>

    <h2 style="margin-top:10px;">å¹¸ã›ãƒãƒ¯ã‚¤è¨ˆç”»ğŸŒ´</h2>
    <div class="sub" id="range"></div>
    <div class="hint" id="hint">ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†ï¼ˆåŒæ™‚ç·¨é›†ãƒ»è‡ªå‹•ä¿å­˜ï¼‰</div>
  </div>

  <div id="root"></div>
</div>

<button class="fab" id="fabAdd" type="button" aria-label="è¿½åŠ ">ï¼‹</button>

<div class="backdrop" id="backdrop"></div>
<div class="sheet" id="sheet">
  <div class="sheetInner">
    <div class="sheetHead">
      <h4 id="sheetTitle"></h4>
      <button class="addBtn" id="addBtn" type="button">ï¼‹äºˆå®šã‚’è¿½åŠ </button>
    </div>
    <div id="editor"></div>
  </div>
  <div class="actions" id="sheetActions">
    <button class="btn" id="closeBtn" type="button">é–‰ã˜ã‚‹</button>
    <button class="btn danger" id="deleteBtn" type="button" style="display:none;">å‰Šé™¤</button>
    <button class="btn primary" id="saveBtn" type="button">ä¿å­˜</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const SLOTS=[{key:"am",label:"AM"},{key:"pm",label:"PM"},{key:"dinner",label:"ãƒ‡ã‚£ãƒŠãƒ¼"}];
  const TAGS=["All","ã‚ã‚“ã±","ã‚ã‚“ã¾","ã“ã†ã™ã‘","ãªãŠ"];
  const START="2025-12-22";
  const END="2026-01-09";
  const CATEGORIES=["é£Ÿäº‹ãƒ»ã‚«ãƒ•ã‚§","ãƒ¬ã‚¸ãƒ£ãƒ¼","è²·ã„ç‰©"];

  // âš ï¸ ã‚ãªãŸã®firebaseConfigã«ç½®æ›
const firebaseConfig = {
  apiKey: "AIzaSyCzLFbx3hKRF5fzLb2qEoQb1RjuBKL9L64",
  authDomain: "itinerary-60bec.firebaseapp.com",
  projectId: "itinerary-60bec",
  storageBucket: "itinerary-60bec.firebasestorage.app",
  messagingSenderId: "174617579746",
  appId: "1:174617579746:web:fc1e6d74dd7c7b86a0cebb"
};

  const $ = (id)=>document.getElementById(id);

  const pad=n=>String(n).padStart(2,"0");
  const toISO=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function dateList(){
    const out=[];
    const d=new Date(START+"T00:00:00");
    while(true){
      const iso=toISO(d);
      out.push(iso);
      if(iso>=END) break;
      d.setDate(d.getDate()+1);
    }
    return out;
  }
  function formatJP(iso){
    const d=new Date(iso+"T00:00:00");
    const w="æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[d.getDay()];
    return `${d.getMonth()+1}/${d.getDate()}(${w})`;
  }
  function id(){
    return "i"+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,6);
  }

  function isHttpUrl(s){
    return /^https?:\/\//i.test(String(s||"").trim());
  }
  function mapHref(v){
    const s=String(v||"").trim();
    if(!s) return "";
    if(isHttpUrl(s)) return s;
    return "https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(s);
  }

  function normalizeMapKey(v){
    const href = mapHref(v);
    if(!href) return "";
    try{
      const u = new URL(href);
      ["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(k=>u.searchParams.delete(k));
      let s = u.toString();
      if(s.endsWith("/")) s = s.slice(0,-1);
      return s;
    }catch{
      return href.trim().replace(/\/$/,"");
    }
  }

  const emptyItem = ()=>({id:id(), time:"", title:"", map:"", tags:[]});
  function makeGrid(){
    const g={};
    for(const d of dateList()){
      g[d]={};
      for(const s of SLOTS) g[d][s.key]=[];
    }
    return g;
  }

  const emptyBook = ()=>({ id:id(), name:"", category:"é£Ÿäº‹ãƒ»ã‚«ãƒ•ã‚§", map:"" });

  function cleanTags(tags){
    let t = Array.isArray(tags) ? tags.filter(x=>TAGS.includes(x)) : [];
    return t.includes("All") ? ["All"] : t;
  }

  function normalizeGrid(raw){
    const g=makeGrid();
    if(!raw || typeof raw!=="object") return g;

    for(const d of Object.keys(g)){
      for(const s of SLOTS){
        const v = raw?.[d]?.[s.key];

        if(v && typeof v==="object" && !Array.isArray(v) && ("time" in v || "title" in v || "map" in v)){
          const one = { id:id(), time:String(v.time||""), title:String(v.title||""), map:String(v.map||""), tags:cleanTags(v.tags) };
          const ok = (one.time.trim()||one.title.trim()||one.map.trim()||one.tags.length);
          g[d][s.key] = ok ? [one] : [];
          continue;
        }

        if(Array.isArray(v)){
          g[d][s.key] = v.map(x=>({
            id:String(x?.id||id()),
            time:String(x?.time||""),
            title:String(x?.title||""),
            map:String(x?.map||""),
            tags:cleanTags(x?.tags)
          })).filter(it => (it.time.trim()||it.title.trim()||it.map.trim()||it.tags.length));
        }
      }
    }
    return g;
  }

  function normalizeBooklist(raw){
    const out=[];
    if(!Array.isArray(raw)) return out;
    raw.forEach(x=>{
      const name=String(x?.name||"").trim();
      const category = CATEGORIES.includes(String(x?.category||"")) ? String(x.category) : "é£Ÿäº‹ãƒ»ã‚«ãƒ•ã‚§";
      const map=String(x?.map||"").trim();
      const ok = name || map;
      if(!ok) return;
      out.push({ id:String(x?.id||id()), name, category, map });
    });
    return out;
  }

  function getTripId(){
    const u=new URL(location.href);
    let t=u.searchParams.get("trip");
    if(!t){
      t="t"+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,6);
      u.searchParams.set("trip", t);
      history.replaceState(null,"",u.toString());
    }
    return t;
  }
  const tripId = getTripId();

  $("range").textContent = `${formatJP(START)} ã€œ ${formatJP(END)}`;

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const tripRef = doc(db, "trips", tripId);

  let view = "schedule";
  let state = { grid: makeGrid(), booklist: [] };
  let editing = null;
  let draftItems = [];
  let draftBook = null;
  let ready=false;

  async function ensureDoc(){
    const snap = await getDoc(tripRef);
    if(!snap.exists()){
      await setDoc(tripRef, {
        grid: makeGrid(),
        booklist: [],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    }
  }

  async function saveSlot(date, slotKey, items){
    const cleaned = (items||[]).map(x=>({
      id: String(x.id || id()),
      time: String(x.time||"").trim(),
      title: String(x.title||"").trim(),
      map: String(x.map||"").trim(),
      tags: cleanTags(x.tags)
    })).filter(it => (it.time||it.title||it.map||it.tags.length));

    const update = {};
    update[`grid.${date}.${slotKey}`] = cleaned;
    update["updatedAt"] = serverTimestamp();
    await updateDoc(tripRef, update);
  }

  async function saveBooklist(next){
    const cleaned = (next||[]).map(x=>({
      id: String(x.id || id()),
      name: String(x.name||"").trim(),
      category: CATEGORIES.includes(String(x.category||"")) ? String(x.category) : "é£Ÿäº‹ãƒ»ã‚«ãƒ•ã‚§",
      map: String(x.map||"").trim()
    })).filter(x=>x.name || x.map);

    await updateDoc(tripRef, { booklist: cleaned, updatedAt: serverTimestamp() });
  }

  // âœ… äºˆå®šæ¸ˆåˆ¤å®šã®ãŸã‚ã«ã€Œäºˆå®šã®åœ°å›³ãƒªãƒ³ã‚¯ã€ã¨ã€Œäºˆå®šåã€ã‚’ã‚»ãƒƒãƒˆåŒ–
  function plannedSets(){
    const linkSet = new Set();
    const titleSet = new Set();
    for(const d of Object.keys(state.grid||{})){
      for(const s of SLOTS){
        const items = state.grid?.[d]?.[s.key] || [];
        items.forEach(it=>{
          const linkKey = normalizeMapKey(it.map);
          if(linkKey) linkSet.add(linkKey);
          const t = String(it.title||"").trim();
          if(t) titleSet.add(t);
        });
      }
    }
    return { linkSet, titleSet };
  }

  function setView(next){
    view = next;
    $("tabSchedule").classList.toggle("active", view==="schedule");
    $("tabBook").classList.toggle("active", view==="book");
    $("hint").textContent = view==="schedule"
      ? "ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†ï¼ˆåŒæ™‚ç·¨é›†ãƒ»è‡ªå‹•ä¿å­˜ï¼‰"
      : "è¡ŒããŸã„å ´æ‰€ã‚’ã‚¹ãƒˆãƒƒã‚¯ï¼ˆäºˆå®šã¨ä¸€è‡´ã™ã‚‹ã¨ã€Œäºˆå®šæ¸ˆã€è¡¨ç¤ºï¼‰";

    $("fabAdd").style.display = (view==="book") ? "flex" : "none";
    render();
  }

  $("tabSchedule").addEventListener("click", ()=>setView("schedule"));
  $("tabBook").addEventListener("click", ()=>setView("book"));
  $("fabAdd").addEventListener("click", ()=>openBookEditor(null));

  function render(){
    if(view==="schedule") renderSchedule();
    else renderBooklist();
  }

  function renderSchedule(){
    const root=$("root");
    root.innerHTML="";

    for(const d of dateList()){
      const day=document.createElement("div");
      day.className="day";
      day.innerHTML = `<strong>${formatJP(d)}</strong>`;

      for(const s of SLOTS){
        const items = state.grid?.[d]?.[s.key] || [];

        const slot=document.createElement("div");
        slot.className="slot";

        const label=document.createElement("div");
        label.className="slotLabel";
        label.textContent = s.label;
        slot.appendChild(label);

        if(!items.length){
          const row=document.createElement("div");
          row.className="row empty";
          row.innerHTML = `<span class="title">ï¼‹ è¿½åŠ </span>`;
          row.onclick = ()=>openSlotEditor(d, s.key);
          slot.appendChild(row);
        }else{
          items.forEach(it=>{
            const row=document.createElement("div");
            row.className="row";
            row.onclick = ()=>openSlotEditor(d, s.key);

            const time=document.createElement("span");
            time.className="time";
            time.textContent = it.time ? it.time : "--:--";
            row.appendChild(time);

            const main=document.createElement("div");
            main.className="main";

            const title=document.createElement("span");
            title.className="title";
            title.textContent = it.title || "";
            main.appendChild(title);

            const tags=document.createElement("span");
            tags.className="tags";
            (it.tags||[]).forEach(t=>{
              const sp=document.createElement("span");
              sp.className="tag";
              sp.textContent=t;
              tags.appendChild(sp);
            });
            main.appendChild(tags);

            row.appendChild(main);

            if(String(it.map||"").trim()){
              const a=document.createElement("a");
              a.className="route";
              a.href = mapHref(it.map);
              a.target="_blank";
              a.rel="noopener noreferrer";
              a.textContent="ğŸ“ãƒ«ãƒ¼ãƒˆæ¤œç´¢";
              a.onclick = (e)=>e.stopPropagation();
              row.appendChild(a);
            }

            slot.appendChild(row);
          });
        }

        day.appendChild(slot);
      }

      root.appendChild(day);
    }
  }

  function renderBooklist(){
    const root=$("root");
    root.innerHTML="";

    const { linkSet, titleSet } = plannedSets();

    const head=document.createElement("div");
    head.className="bookHead";
    const left=document.createElement("div");
    left.innerHTML = `
      <div class="bookTitle">ãƒ–ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>
      <div class="bookSub">trip: ${tripId}</div>
    `;
    head.appendChild(left);
    root.appendChild(head);

    if(!state.booklist.length){
      const empty=document.createElement("div");
      empty.style.marginTop="12px";
      empty.style.color="var(--muted)";
      empty.style.fontSize="13px";
      empty.textContent="ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸‹ã®ã€Œï¼‹ã€ã‹ã‚‰ç™»éŒ²ã§ãã¾ã™ã€‚";
      root.appendChild(empty);
      return;
    }

    const grouped = {};
    CATEGORIES.forEach(c=>grouped[c]=[]);
    state.booklist.forEach(b=>{
      const c = CATEGORIES.includes(b.category) ? b.category : CATEGORIES[0];
      grouped[c].push(b);
    });

    CATEGORIES.forEach(cat=>{
      const items = grouped[cat] || [];
      if(!items.length) return;

      const sec=document.createElement("div");
      sec.className="bookSection";

      const h=document.createElement("div");
      h.className="bookSectionTitle";
      h.textContent = cat;
      sec.appendChild(h);

      items.forEach(b=>{
        const item=document.createElement("div");
        item.className="bookItem";
        item.onclick=()=>openBookEditor(b.id);

        const left=document.createElement("div");
        left.className="bookLeft";

        // âœ… å ´æ‰€åã®æ¨ªã«ã€Œäºˆå®šæ¸ˆã€
        const nameRow = document.createElement("div");
        nameRow.style.display = "flex";
        nameRow.style.alignItems = "center";
        nameRow.style.gap = "8px";
        nameRow.style.minWidth = "0";

        const name=document.createElement("div");
        name.className="bookName";
        name.textContent = b.name || "(åç§°æœªå…¥åŠ›)";
        name.style.flex = "1 1 auto";
        name.style.minWidth = "0";
        nameRow.appendChild(name);

        // âœ… äºˆå®šæ¸ˆæ¡ä»¶ï¼šãƒªãƒ³ã‚¯ä¸€è‡´ OR å ´æ‰€å==äºˆå®šå
        const key = normalizeMapKey(b.map);
        const bn = String(b.name||"").trim();
        const isPlanned = (key && linkSet.has(key)) || (bn && titleSet.has(bn));
        if(isPlanned){
          const ok=document.createElement("span");
          ok.className="badge ok";
          ok.textContent="âœ… äºˆå®šæ¸ˆ";
          nameRow.appendChild(ok);
        }

        left.appendChild(nameRow);
        item.appendChild(left);

        // âœ… åœ°å›³ãƒœã‚¿ãƒ³ï¼ˆå°ã•ãï¼‰
        if(String(b.map||"").trim()){
          const a=document.createElement("a");
          a.className="miniLink";
          a.href = mapHref(b.map);
          a.target="_blank";
          a.rel="noopener noreferrer";
          a.textContent="ğŸ“åœ°å›³";
          a.onclick=(e)=>e.stopPropagation();
          item.appendChild(a);
        }

        sec.appendChild(item);
      });

      root.appendChild(sec);
    });
  }

  function openSlotEditor(date, slotKey){
    editing = { type:"slot", date, slotKey };

    $("deleteBtn").style.display="none";
    $("addBtn").style.display="none";
    $("sheetTitle").textContent = `${formatJP(date)} / ${SLOTS.find(x=>x.key===slotKey)?.label || slotKey}`;
    $("saveBtn").textContent="ä¿å­˜";

    const cur = state.grid?.[date]?.[slotKey] || [];
    draftItems = cur.length
      ? cur.map(x=>({ ...x, tags: Array.isArray(x.tags)? [...x.tags] : [] }))
      : [ emptyItem() ];

    $("addBtn").style.display = (cur.length >= 1) ? "inline-block" : "none";
    renderSlotEditor();
    openSheet();
  }

  function renderSlotEditor(){
    const box=$("editor");
    box.innerHTML="";
    draftItems.forEach((it, idx)=> box.appendChild(itemEditor(it, idx)));
  }

  function itemEditor(it, idx){
    const wrap=document.createElement("div");
    wrap.className="setBox";

    const head=document.createElement("div");
    head.className="setTop";

    const st=document.createElement("div");
    st.className="setTitle";
    st.textContent = `äºˆå®š ${idx+1}`;
    head.appendChild(st);

    if(draftItems.length > 1){
      const del=document.createElement("button");
      del.type="button";
      del.className="delBtn";
      del.textContent="å‰Šé™¤";
      del.onclick=()=>{
        const i = draftItems.findIndex(x=>x.id===it.id);
        if(i>=0){
          draftItems.splice(i,1);
          $("addBtn").style.display = (draftItems.length >= 1) ? "inline-block" : "none";
          renderSlotEditor();
        }
      };
      head.appendChild(del);
    }
    wrap.appendChild(head);

    const row2=document.createElement("div");
    row2.className="row2";

    const time=document.createElement("input");
    time.type="time";
    time.className="input";
    time.value = it.time || "";
    time.oninput = (e)=>{ it.time = e.target.value; };

    const title=document.createElement("input");
    title.className="input";
    title.placeholder="äºˆå®šå";
    title.value = it.title || "";
    title.oninput = (e)=>{ it.title = e.target.value; };

    row2.appendChild(time);
    row2.appendChild(title);
    wrap.appendChild(row2);

    const l1=document.createElement("div");
    l1.className="label";
    l1.textContent="å ´æ‰€ï¼ˆGoogle Mapsãƒªãƒ³ã‚¯ or ä½æ‰€/åº—åï¼‰";
    wrap.appendChild(l1);

    const map=document.createElement("input");
    map.className="input";
    map.placeholder="ä¾‹ï¼šãƒ›ãƒ†ãƒ«å / æ¸‹è°·é§… / https://maps.app.goo.gl/...";
    map.value = it.map || "";
    map.oninput = (e)=>{ it.map = e.target.value; };
    wrap.appendChild(map);

    const l2=document.createElement("div");
    l2.className="label";
    l2.textContent="ã‚¿ã‚°ï¼ˆAllã¯ä»–ã¨åŒæ™‚é¸æŠä¸å¯ï¼‰";
    wrap.appendChild(l2);

    const tagRow=document.createElement("div");
    tagRow.className="tagRow";

    TAGS.forEach(t=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="tagBtn"+((it.tags||[]).includes(t)?" active":"");
      b.textContent=t;

      b.onclick=()=>{
        it.tags = Array.isArray(it.tags) ? it.tags : [];
        if(t==="All"){
          it.tags=["All"];
          [...tagRow.children].forEach(btn=> btn.classList.toggle("active", btn.textContent==="All"));
        }else{
          it.tags = it.tags.filter(x=>x!=="All");
          if(it.tags.includes(t)){
            it.tags = it.tags.filter(x=>x!==t);
            b.classList.remove("active");
          }else{
            it.tags.push(t);
            b.classList.add("active");
          }
          [...tagRow.children].forEach(btn=>{ if(btn.textContent==="All") btn.classList.remove("active"); });
        }
      };
      tagRow.appendChild(b);
    });

    wrap.appendChild(tagRow);
    return wrap;
  }

  function openBookEditor(bookId){
    editing = { type:"book", id: bookId };

    $("addBtn").style.display="none";
    $("saveBtn").textContent="ä¿å­˜";

    const found = state.booklist.find(x=>x.id===bookId);
    draftBook = found ? { ...found } : emptyBook();

    $("sheetTitle").textContent = bookId ? "ãƒ–ãƒƒã‚¯ãƒªã‚¹ãƒˆç·¨é›†" : "ãƒ–ãƒƒã‚¯ãƒªã‚¹ãƒˆè¿½åŠ ";
    $("deleteBtn").style.display = bookId ? "inline-block" : "none";

    renderBookEditor();
    openSheet();
  }

  function renderBookEditor(){
    const box=$("editor");
    box.innerHTML="";

    const wrap=document.createElement("div");
    wrap.className="setBox";

    const l1=document.createElement("div");
    l1.className="label";
    l1.textContent="å ´æ‰€å";
    wrap.appendChild(l1);

    const name=document.createElement("input");
    name.className="input";
    name.placeholder="ä¾‹ï¼šã€‡ã€‡ã‚«ãƒ•ã‚§ / â–³â–³å…¬åœ’";
    name.value = draftBook.name || "";
    name.oninput=(e)=>{ draftBook.name = e.target.value; };
    wrap.appendChild(name);

    const l2=document.createElement("div");
    l2.className="label";
    l2.textContent="ã‚«ãƒ†ã‚´ãƒª";
    wrap.appendChild(l2);

    const sel=document.createElement("select");
    sel.className="input";
    CATEGORIES.forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c; opt.textContent=c;
      if((draftBook.category||CATEGORIES[0])===c) opt.selected=true;
      sel.appendChild(opt);
    });
    sel.onchange=(e)=>{ draftBook.category = e.target.value; };
    wrap.appendChild(sel);

    const l3=document.createElement("div");
    l3.className="label";
    l3.textContent="Googleãƒãƒƒãƒ—ï¼ˆãƒªãƒ³ã‚¯ or ä½æ‰€/åº—åï¼‰";
    wrap.appendChild(l3);

    const map=document.createElement("input");
    map.className="input";
    map.placeholder="ä¾‹ï¼šhttps://maps.app.goo.gl/... ã¾ãŸã¯ æ¸‹è°·é§…";
    map.value = draftBook.map || "";
    map.oninput=(e)=>{ draftBook.map = e.target.value; };
    wrap.appendChild(map);

    box.appendChild(wrap);
  }

  function openSheet(){
    $("backdrop").style.display="block";
    $("sheet").style.display="block";
  }
  function closeSheet(){
    $("backdrop").style.display="none";
    $("sheet").style.display="none";
    editing=null;
    draftItems=[];
    draftBook=null;
  }

  $("addBtn").addEventListener("click", ()=>{
    draftItems.push(emptyItem());
    renderSlotEditor();
  });

  $("backdrop").addEventListener("click", closeSheet);
  $("closeBtn").addEventListener("click", closeSheet);

  $("deleteBtn").addEventListener("click", async ()=>{
    try{
      if(!editing || editing.type!=="book") return;
      if(!ready) return;

      const next = state.booklist.filter(x=>x.id!==editing.id);
      await saveBooklist(next);
      closeSheet();
    }catch(e){
      console.error(e);
      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:\n"+(e?.message||e));
    }
  });

  $("saveBtn").addEventListener("click", async ()=>{
    try{
      if(!editing) return;
      if(!ready){
        alert("åˆæœŸåŒ–ä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if(editing.type==="slot"){
        await saveSlot(editing.date, editing.slotKey, draftItems);
        closeSheet();
        return;
      }

      if(editing.type==="book"){
        const next = [...state.booklist];
        const cleaned = {
          id: String(draftBook.id || id()),
          name: String(draftBook.name||"").trim(),
          category: CATEGORIES.includes(String(draftBook.category||"")) ? String(draftBook.category) : CATEGORIES[0],
          map: String(draftBook.map||"").trim()
        };
        if(!cleaned.name && !cleaned.map){
          alert("å ´æ‰€åã‹åœ°å›³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const i = next.findIndex(x=>x.id===cleaned.id);
        if(i>=0) next[i]=cleaned;
        else next.unshift(cleaned);

        await saveBooklist(next);
        closeSheet();
        return;
      }
    }catch(e){
      console.error(e);
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + (e?.message || e));
    }
  });

  // boot
  render();

  signInAnonymously(auth).catch((e)=>{
    console.error(e);
    alert("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebase Authenticationã§Anonymousã‚’ONã«ã—ã¦ãã ã•ã„ã€‚");
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;

    await ensureDoc();
    ready=true;

    onSnapshot(tripRef, (snap)=>{
      const data = snap.data();
      if(!data) return;

      state.grid = normalizeGrid(data.grid);
      state.booklist = normalizeBooklist(data.booklist);

      render();
    }, (err)=>{
      console.error(err);
      alert("Firestoreè³¼èª­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    });
  });

  setView("schedule");
</script>
</body>
</html>
    
  </body>
  
</html>
