<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Itinerary</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</title>
<style>
  :root{
    --border:#ddd; --bg:#f6f6f6; --text:#111; --muted:#666; --black:#111;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:#fff;}
  .app{max-width:760px;margin:0 auto;padding:12px;}

  h2{margin:0;font-size:20px;line-height:1.2;}
  .sub{margin-top:4px;font-size:12px;color:var(--muted);}
  .hint{margin-top:8px;font-size:12px;color:var(--muted);}

  .topbar{
    position:sticky; top:0; z-index:50; background:#fff;
    padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06);
  }

  .day{border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px;}
  .day strong{font-size:14px;}

  .slot{margin-top:10px;}
  .slotLabel{font-size:12px;font-weight:900;color:#333;margin-bottom:6px;}

  /* ãƒ¡ã‚¤ãƒ³ï¼š1è¡Œã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ */
  .row{
    display:flex; align-items:center; gap:8px;
    padding:6px 8px; border-radius:12px; background:var(--bg);
    margin-top:6px; cursor:pointer;
  }
  .row.empty{opacity:.55; padding:6px 8px;}

  .time{
    font-weight:900;
    font-variant-numeric:tabular-nums;
    white-space:nowrap;
    font-size:12px;
    width:56px;               /* æ™‚é–“ã®å¹…ã‚’å›ºå®šã—ã¦æƒãˆã‚‹ */
    flex:0 0 auto;
  }

  /* âœ… äºˆå®šå + ã‚¿ã‚°ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚’å³ç«¯å›ºå®šã™ã‚‹ãŸã‚ï¼‰ */
  .main{
    display:flex;
    align-items:center;
    gap:8px;
    min-width:0;
    flex:1 1 auto;
  }

  .title{
    min-width:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-size:13px;
    flex:0 1 auto;
  }

  /* âœ… ã‚¿ã‚°ã¯äºˆå®šåã®æ¨ªï¼ˆåŒä¸€ãƒ–ãƒ­ãƒƒã‚¯å†…ï¼‰ */
  .tags{
    display:flex;
    gap:4px;
    flex:0 0 auto;
    flex-wrap:nowrap;
    overflow:hidden;           /* ã‚¿ã‚°ãŒå¤šã„æ™‚ã¯åˆ‡ã‚Œã‚‹ï¼ˆå³ç«¯ã®ãƒœã‚¿ãƒ³ã¯æ®‹ã‚‹ï¼‰ */
    max-width:220px;
  }

  .tag{
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;           /* âœ… Allã‚‚ç™½èƒŒæ™¯ */
    white-space:nowrap;
    color:#111;
  }

  /* âœ… ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã¯å¸¸ã«å³ç«¯å›ºå®š */
  .route{
    font-size:11px;
    padding:5px 9px;
    border-radius:999px;
    background:#111;
    color:#fff;
    text-decoration:none;
    white-space:nowrap;
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-weight:900;
    margin-left:auto;          /* âœ… å³ç«¯ã¸æŠ¼ã—å‡ºã™ */
    flex:0 0 auto;
  }
  .route:active{transform:translateY(1px);}

  /* bottom sheet */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:80; display:none;}
  .sheet{
    position:fixed; left:0; right:0; bottom:0;
    background:#fff; border-top:1px solid var(--border);
    border-radius:16px 16px 0 0;
    max-width:760px; margin:0 auto;
    z-index:90; display:none;
  }
  .sheetInner{padding:12px; max-height:62vh; overflow:auto;}
  .sheetHead{display:flex; align-items:center; justify-content:space-between; gap:8px;}
  .sheetHead h4{margin:0; font-size:14px;}

  .addBtn{
    font-size:12px; font-weight:900;
    border:1px solid var(--border);
    padding:8px 12px; border-radius:999px; background:#fff;
    cursor:pointer; display:none;
  }
  .addBtn:active{transform:translateY(1px);}

  .setBox{border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:10px; margin-top:10px; background:#fff;}
  .setTop{display:flex; align-items:center; justify-content:space-between; gap:8px;}
  .setTitle{font-size:12px; font-weight:900; color:#333;}
  .delBtn{
    border:1px solid #e5b3b3; color:#b00020; background:#fff;
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
    cursor:pointer;
  }

  .row2{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;}
  .label{font-size:12px; color:var(--muted); margin-top:10px;}
  .input{
    width:100%; padding:10px; border:1px solid var(--border);
    border-radius:12px; font-size:14px; margin-top:6px;
  }

  .tagRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
  .tagBtn{
    border:1px solid var(--border); background:#fff; padding:8px 12px;
    border-radius:999px; font-size:12px; font-weight:900; cursor:pointer;
  }
  .tagBtn.active{background:#111;color:#fff;border-color:#111;}

  .actions{display:flex; gap:8px; padding:10px 12px 12px; border-top:1px solid rgba(0,0,0,.06);}
  .btn{
    flex:1; padding:14px 0; border-radius:14px; border:1px solid var(--border);
    background:#fff; font-weight:900; font-size:15px; cursor:pointer;
  }
  .btn.primary{background:#111;color:#fff;border-color:#111; flex:1.2;}
  .btn:active{transform:translateY(1px);}

  @media (max-width:520px){
    h2{font-size:18px;}
    .row2{grid-template-columns:1fr;}
    .tags{max-width:150px;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h2>æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸŒ´</h2>
    <div class="sub" id="range"></div>
    <div class="hint">ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†ï¼ˆåŒæ™‚ç·¨é›†ãƒ»è‡ªå‹•ä¿å­˜ï¼‰</div>
  </div>
  <div id="root"></div>
</div>

<div class="backdrop" id="backdrop"></div>
<div class="sheet" id="sheet">
  <div class="sheetInner">
    <div class="sheetHead">
      <h4 id="sheetTitle"></h4>
      <button class="addBtn" id="addBtn" type="button">ï¼‹äºˆå®šã‚’è¿½åŠ </button>
    </div>
    <div id="editor"></div>
  </div>
  <div class="actions">
    <button class="btn" id="closeBtn" type="button">é–‰ã˜ã‚‹</button>
    <button class="btn primary" id="saveBtn" type="button">ä¿å­˜</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const SLOTS=[{key:"am",label:"AM"},{key:"pm",label:"PM"},{key:"dinner",label:"ãƒ‡ã‚£ãƒŠãƒ¼"}];
  const TAGS=["All","ã‚ã‚“ã±","ã‚ã‚“ã¾","ã“ã†ã™ã‘","ãªãŠ"];
  const START="2025-12-22";
  const END="2026-01-09";

  // âš ï¸ã‚ãªãŸã®firebaseConfigã«ç½®æ›
const firebaseConfig = {
  apiKey: "AIzaSyCzLFbx3hKRF5fzLb2qEoQb1RjuBKL9L64",
  authDomain: "itinerary-60bec.firebaseapp.com",
  projectId: "itinerary-60bec",
  storageBucket: "itinerary-60bec.firebasestorage.app",
  messagingSenderId: "174617579746",
  appId: "1:174617579746:web:fc1e6d74dd7c7b86a0cebb"
};

  const $ = (id)=>document.getElementById(id);

  const pad=n=>String(n).padStart(2,"0");
  const toISO=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function dateList(){
    const out=[];
    const d=new Date(START+"T00:00:00");
    while(true){
      const iso=toISO(d);
      out.push(iso);
      if(iso>=END) break;
      d.setDate(d.getDate()+1);
    }
    return out;
  }
  function formatJP(iso){
    const d=new Date(iso+"T00:00:00");
    const w="æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[d.getDay()];
    return `${d.getMonth()+1}/${d.getDate()}(${w})`;
  }
  function mapHref(v){
    const s=String(v||"").trim();
    if(!s) return "";
    if(/^https?:\/\//i.test(s)) return s;
    return "https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(s);
  }
  function id(){
    return "i"+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,6);
  }

  const emptyItem = ()=>({id:id(), time:"", title:"", map:"", tags:[]});
  function makeGrid(){
    const g={};
    for(const d of dateList()){
      g[d]={};
      for(const s of SLOTS) g[d][s.key]=[];
    }
    return g;
  }
  function cleanTags(tags){
    let t = Array.isArray(tags) ? tags.filter(x=>TAGS.includes(x)) : [];
    return t.includes("All") ? ["All"] : t;
  }
  function normalizeGrid(raw){
    const g=makeGrid();
    if(!raw || typeof raw!=="object") return g;

    for(const d of Object.keys(g)){
      for(const s of SLOTS){
        const v = raw?.[d]?.[s.key];

        if(v && typeof v==="object" && !Array.isArray(v) && ("time" in v || "title" in v || "map" in v)){
          const one = { id:id(), time:String(v.time||""), title:String(v.title||""), map:String(v.map||""), tags:cleanTags(v.tags) };
          const ok = (one.time.trim()||one.title.trim()||one.map.trim()||one.tags.length);
          g[d][s.key] = ok ? [one] : [];
          continue;
        }

        if(Array.isArray(v)){
          g[d][s.key] = v.map(x=>({
            id:String(x?.id||id()),
            time:String(x?.time||""),
            title:String(x?.title||""),
            map:String(x?.map||""),
            tags:cleanTags(x?.tags)
          })).filter(it => (it.time.trim()||it.title.trim()||it.map.trim()||it.tags.length));
        }
      }
    }
    return g;
  }

  function getTripId(){
    const u=new URL(location.href);
    let t=u.searchParams.get("trip");
    if(!t){
      t="t"+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,6);
      u.searchParams.set("trip", t);
      history.replaceState(null,"",u.toString());
    }
    return t;
  }
  const tripId = getTripId();

  $("range").textContent = `${formatJP(START)} ã€œ ${formatJP(END)}`;

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const tripRef = doc(db, "trips", tripId);

  let state = { grid: makeGrid() };
  let editing = null;
  let draftItems = [];
  let ready=false;

  async function ensureDoc(){
    const snap = await getDoc(tripRef);
    if(!snap.exists()){
      await setDoc(tripRef, { grid: makeGrid(), createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
    }
  }
  async function saveSlot(date, slotKey, items){
    const cleaned = (items||[]).map(x=>({
      id: String(x.id || id()),
      time: String(x.time||"").trim(),
      title: String(x.title||"").trim(),
      map: String(x.map||"").trim(),
      tags: cleanTags(x.tags)
    })).filter(it => (it.time||it.title||it.map||it.tags.length));

    const update = {};
    update[`grid.${date}.${slotKey}`] = cleaned;
    update["updatedAt"] = serverTimestamp();
    await updateDoc(tripRef, update);
  }

  function renderMain(){
    const root=$("root");
    root.innerHTML="";

    for(const d of dateList()){
      const day=document.createElement("div");
      day.className="day";
      day.innerHTML = `<strong>${formatJP(d)}</strong>`;

      for(const s of SLOTS){
        const items = state.grid?.[d]?.[s.key] || [];

        const slot=document.createElement("div");
        slot.className="slot";

        const label=document.createElement("div");
        label.className="slotLabel";
        label.textContent = s.label;
        slot.appendChild(label);

        if(!items.length){
          const row=document.createElement("div");
          row.className="row empty";
          row.innerHTML = `<span class="title">ï¼‹ è¿½åŠ </span>`;
          row.onclick = ()=>openEditor(d, s.key);
          slot.appendChild(row);
        }else{
          items.forEach(it=>{
            const row=document.createElement("div");
            row.className="row";
            row.onclick = ()=>openEditor(d, s.key);

            const time=document.createElement("span");
            time.className="time";
            time.textContent = it.time ? it.time : "--:--";
            row.appendChild(time);

            // âœ… äºˆå®šåã®æ¨ªã«ã‚¿ã‚°ï¼ˆmainãƒ–ãƒ­ãƒƒã‚¯ï¼‰
            const main=document.createElement("div");
            main.className="main";

            const title=document.createElement("span");
            title.className="title";
            title.textContent = it.title || "";
            main.appendChild(title);

            const tags=document.createElement("span");
            tags.className="tags";
            (it.tags||[]).forEach(t=>{
              const sp=document.createElement("span");
              sp.className="tag"; // âœ… Allã‚‚åŒã˜è¦‹ãŸç›®ï¼ˆç™½èƒŒæ™¯ï¼‰
              sp.textContent=t;
              tags.appendChild(sp);
            });
            main.appendChild(tags);

            row.appendChild(main);

            // âœ… ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚’ä¸€ç•ªå³ç«¯ã«å›ºå®š
            if(String(it.map||"").trim()){
              const a=document.createElement("a");
              a.className="route";
              a.href = mapHref(it.map);
              a.target="_blank";
              a.rel="noopener noreferrer";
              a.textContent="ğŸ“ãƒ«ãƒ¼ãƒˆæ¤œç´¢";
              a.onclick = (e)=>e.stopPropagation();
              row.appendChild(a);
            }

            slot.appendChild(row);
          });
        }

        day.appendChild(slot);
      }

      root.appendChild(day);
    }
  }

  function openEditor(date, slotKey){
    editing = {date, slotKey};
    const slotLabel = SLOTS.find(x=>x.key===slotKey)?.label || slotKey;
    $("sheetTitle").textContent = `${formatJP(date)} / ${slotLabel}`;

    const cur = state.grid?.[date]?.[slotKey] || [];
    draftItems = cur.length
      ? cur.map(x=>({ ...x, tags: Array.isArray(x.tags)? [...x.tags] : [] }))
      : [ emptyItem() ];

    $("addBtn").style.display = (cur.length >= 1) ? "inline-block" : "none";

    renderEditor();

    $("backdrop").style.display="block";
    $("sheet").style.display="block";
  }

  function closeEditor(){
    $("backdrop").style.display="none";
    $("sheet").style.display="none";
    editing=null;
    draftItems=[];
  }

  function renderEditor(){
    const box=$("editor");
    box.innerHTML="";
    draftItems.forEach((it, idx)=>{
      box.appendChild(itemEditor(it, idx));
    });
  }

  // ã‚¿ã‚°ã§å†æç”»ã—ãªã„ï¼ˆå…¥åŠ›ãŒæ¶ˆãˆãªã„ï¼‰
  function itemEditor(it, idx){
    const wrap=document.createElement("div");
    wrap.className="setBox";

    const head=document.createElement("div");
    head.className="setTop";

    const st=document.createElement("div");
    st.className="setTitle";
    st.textContent = `äºˆå®š ${idx+1}`;
    head.appendChild(st);

    if(draftItems.length > 1){
      const del=document.createElement("button");
      del.type="button";
      del.className="delBtn";
      del.textContent="å‰Šé™¤";
      del.onclick=()=>{
        const i = draftItems.findIndex(x=>x.id===it.id);
        if(i>=0){
          draftItems.splice(i,1);
          $("addBtn").style.display = (draftItems.length >= 1) ? "inline-block" : "none";
          renderEditor();
        }
      };
      head.appendChild(del);
    }
    wrap.appendChild(head);

    const row2=document.createElement("div");
    row2.className="row2";

    const time=document.createElement("input");
    time.type="time";
    time.className="input";
    time.value = it.time || "";
    time.oninput = (e)=>{ it.time = e.target.value; };

    const title=document.createElement("input");
    title.className="input";
    title.placeholder="äºˆå®šå";
    title.value = it.title || "";
    title.oninput = (e)=>{ it.title = e.target.value; };

    row2.appendChild(time);
    row2.appendChild(title);
    wrap.appendChild(row2);

    const l1=document.createElement("div");
    l1.className="label";
    l1.textContent="å ´æ‰€ï¼ˆGoogle Mapsãƒªãƒ³ã‚¯ or ä½æ‰€/åº—åï¼‰";
    wrap.appendChild(l1);

    const map=document.createElement("input");
    map.className="input";
    map.placeholder="ä¾‹ï¼šãƒ›ãƒ†ãƒ«å / æ¸‹è°·é§… / https://maps.app.goo.gl/...";
    map.value = it.map || "";
    map.oninput = (e)=>{ it.map = e.target.value; };
    wrap.appendChild(map);

    const l2=document.createElement("div");
    l2.className="label";
    l2.textContent="ã‚¿ã‚°ï¼ˆAllã¯ä»–ã¨åŒæ™‚é¸æŠä¸å¯ï¼‰";
    wrap.appendChild(l2);

    const tagRow=document.createElement("div");
    tagRow.className="tagRow";

    TAGS.forEach(t=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="tagBtn"+((it.tags||[]).includes(t)?" active":"");
      b.textContent=t;

      b.onclick=()=>{
        it.tags = Array.isArray(it.tags) ? it.tags : [];

        if(t==="All"){
          it.tags=["All"];
          [...tagRow.children].forEach(btn=>{
            btn.classList.toggle("active", btn.textContent==="All");
          });
        }else{
          it.tags = it.tags.filter(x=>x!=="All");
          if(it.tags.includes(t)){
            it.tags = it.tags.filter(x=>x!==t);
            b.classList.remove("active");
          }else{
            it.tags.push(t);
            b.classList.add("active");
          }
          [...tagRow.children].forEach(btn=>{
            if(btn.textContent==="All") btn.classList.remove("active");
          });
        }
      };

      tagRow.appendChild(b);
    });

    wrap.appendChild(tagRow);
    return wrap;
  }

  $("addBtn").addEventListener("click", ()=>{
    draftItems.push(emptyItem());
    renderEditor();
  });

  $("backdrop").addEventListener("click", closeEditor);
  $("closeBtn").addEventListener("click", closeEditor);

  $("saveBtn").addEventListener("click", async ()=>{
    try{
      if(!editing) return;
      if(!ready){
        alert("åˆæœŸåŒ–ä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      await saveSlot(editing.date, editing.slotKey, draftItems);
      closeEditor();
    }catch(e){
      console.error(e);
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + (e?.message || e));
    }
  });

  renderMain();

  signInAnonymously(auth).catch((e)=>{
    console.error(e);
    alert("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebase Authenticationã§Anonymousã‚’ONã«ã—ã¦ãã ã•ã„ã€‚");
  });

  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;

    await ensureDoc();
    ready=true;

    onSnapshot(tripRef, (snap)=>{
      const data = snap.data();
      if(!data) return;
      state.grid = normalizeGrid(data.grid);
      renderMain();
    }, (err)=>{
      console.error(err);
      alert("Firestoreè³¼èª­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    });
  });
</script>
</body>
</html>
    
  </body>
  
</html>
